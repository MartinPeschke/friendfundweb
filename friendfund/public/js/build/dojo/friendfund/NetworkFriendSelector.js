/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["friendfund.NetworkFriendSelector"]){dojo._hasResource["friendfund.NetworkFriendSelector"]=true;dojo.provide("friendfund.NetworkFriendSelector");dojo.require("friendfund.EmailFriendSelector");dojo.require("ff.t");dojo.require("ff.io");dojo.declare("friendfund.NetworkFriendPanel",friendfund._Selector,{constructor:function(_1){dojo.mixin(this,_1);},draw:function(){ff.io.xhrPost(this.base_url+"/"+this.network,{},dojo.hitch(this,"onLoad"));},onLoad:function(_2){dojo.place(_2.html,this.ref_node,"only");dojo.style(this.ref_node,"display","Block");},destroy:function(){dojo.forEach(this._listener_locals,dojo.disconnect);this._listener_locals=[];},select:function(_3){var _4=ff.t.findParent(_3.target,"invitee_row");if(_4){this.checkScrollingState();return this.onSelect(_4,_3);}}});dojo.declare("friendfund.DataProvider",friendfund.NetworkFriendPanel,{constructor:function(_5){dojo.mixin(this,_5);this._rendering=false;this._current_display_idx=0;this._fully_loaded=false;this._search_index={};},addToSearchIndex:function(ud){ud["dom_id"]=this.network+"_"+ud.network_id;var s,_6,i,j,k,_7,_8={};s=ud.name.split(" ").concat([ud.name]);for(i=0;i<s.length;i++){_6=s[i];for(j=0;j<=_6.length;j++){k=_6.substr(0,j).toLowerCase();_8[k]=true;}}for(k in _8){_7=this._search_index[k]||[];if(_7.push){_7.push(ud);this._search_index[k]=_7;}}if(this.current_filter.length&&_8[this.current_filter]){this.renderUserAndPlace(ud);}},_addPage:function(_9,_a){var i,ud;for(i=0;i<_9.length;i++){ud=_9[i];this.addToSearchIndex(ud);}this._fully_loaded=_a;},renderSlice:function(_b,_c){var _d=ff.t.render,_e=this.friends_template,_f=this._selected,_10=this.mutuals,si=this._search_index[this.current_filter||""]||[],_11=[],_12=[],len=si.length,i;for(i=this._current_display_idx;i<len;i++){if(!_f[si[i].dom_id]&&(!_10||_10&&si[i].mutual_with)){_11.push(si[i]);}if(_11.length<=_b){this._current_display_idx++;}}len=_11.length>_b?_b:_11.length;for(i=0;i<len;i++){_12.push(_d(_e,_11[i]));}if(_c){_12.push("<li id=\"loading_placeholder_"+this.network+"\">&nbsp;</li>");}return _12;},getFirstPage:function(){this._current_display_idx=0;return this.renderSlice(this._page_size,true);},getNextPage:function(){return this.renderSlice(this._page_size);},hasMoreFriends:function(){return !this._fully_loaded||this._current_display_idx<this._search_index[this.current_filter||""].length;},reRender:function(){var _13=this.getFirstPage();if(_13.length){dojo.place(_13.join(""),this.friendlist,"only");}else{delete dojo.query("*",this.friendlist).orphan();}},_checkScrollingState:function(evt){friendlist_loader=dojo.byId("loading_placeholder_"+this.network);if(!friendlist_loader){return;}var pos=dojo.position(friendlist_loader);if(pos.y<friendlist_box){if(this.hasMoreFriends()){dojo.place(this.getNextPage().join(""),friendlist_loader,"before");}}}});dojo.declare("friendfund.NetworkFriendSelector",friendfund.DataProvider,{rootNode:null,_is_loading:false,_page_size:20,current_filter:"",_selected:{},constructor:function(_14){dojo.mixin(this,_14);if(this.invited_node){this.invited_node=dojo.isString(this.invited_node)&&dojo.byId(this.invited_node)||this.invited_node;}else{this.invited_node=null;}_is_selected_decider=".methodselector.ajaxlink.selected[_type="+this.network+"]";this.lazyReRender=ff.t.debounce(dojo.hitch(this,"reRender"),200,false);this.checkScrollingState=ff.t.debounce(dojo.hitch(this,"_checkScrollingState"),100,false);},is_selected:function(){return dojo.query(this._is_selected_decider,this.container).length>0;},draw:function(){if(this.rootNode){dojo.removeClass(this.rootNode,"hidden");}else{if(!this.is_selected()||this._is_loading!==true){this._is_loading=true;var l=dojo.query("#networkinviter_"+this.network);if(l.length){l.orphan();}this.rootNode=dojo.create("DIV",{"id":("networkinviter_"+this.network)});dojo.byId(this.ref_node).appendChild(this.rootNode);dojo.place(this._loader,this.rootNode,"only");ff.io.xhrPost(this.base_url+"/"+this.network,{},dojo.hitch(this,"onLoad"));}}},undraw:function(){if(this.rootNode){dojo.addClass(this.rootNode,"hidden");}else{var l=dojo.query("#networkinviter_"+this.network);if(l.length){l.orphan();}}dojo.forEach(this._listener_locals,dojo.disconnect);this._listener_locals=[];},onLoad:function(_15){var _16=this;_16._is_loading=false;dojo.place(_15.html,_16.rootNode,"only");if(_15.success){_16.friendlist=dojo.byId("friend_list_"+_16.network);friendlist_box=dojo.position(_16.friendlist);friendlist_box=friendlist_box.h*2+friendlist_box.y;_16.friends_template=_15.template;var _17=dojo.byId("toggle_mutuals_"+_16.network);if(_17){dojo.connect(_17,"onclick",_16,"toggle_mutuals");_16.mutuals=_17.checked;}else{_16.mutuals=false;}_16._addPage(_15.friends,_15.is_complete);_16.reRender();_16.filterNode=dojo.byId("filter_"+_16.network);dojo.connect(_16.friendlist,"onclick",_16,"select");dojo.connect(_16.filterNode,"onkeyup",_16,"filter");ff.w.parseDefaultsInputs(_16.ref_node);dojo.connect(_16.friendlist,"onscroll",this.checkScrollingState);if(!_15.is_complete){ff.io.xhrPost(_16.base_url+"/ext_"+_16.network,{offset:_15.offset},dojo.hitch(_16,"addLoad"));}}else{dojo.query("a.facebookBtn",_16.rootNode).forEach(function(_18){level=parseInt(dojo.attr(_18,"_level"),10);dojo.connect(_18,"onclick",dojo.hitch(_16.auth_provider,"doFBLogin",{level:level,success:dojo.hitch(_16,"draw")}));});dojo.query("a.twitterBtn",_16.rootNode).forEach(function(_19){level=parseInt(dojo.attr(_19,"_level"),10);dojo.connect(_19,"onclick",dojo.hitch(_16.auth_provider,"doTWLogin",{level:level,success:dojo.hitch(_16,"draw")}));});_16.rootNode=null;}},addLoad:function(_1a){if(!!_1a.friends){this._addPage(_1a.friends,_1a.is_complete);}if(!_1a.is_complete){ff.io.xhrPost(this.base_url+"/ext_"+this.network,{offset:_1a.offset},dojo.hitch(this,"addLoad"));}},onSelect:function(_1b,evt){dojo.query("p.inviterTwo",this.global_invited_node).addClass("hidden");this.inviteAppendNode(_1b);var el=dojo.byId("invitedCounter");el.innerHTML=parseInt(el.innerHTML,10)+1;},inviteAppendNode:function(_1c){var _1d=this;dojo.query(_1c).orphan().forEach(function(_1e){dojo.place(_1e,_1d.invited_node,"last");_1d._selected[_1e.id]=true;});},uninviteAppendNode:function(_1f){delete this._selected[_1f.id];this.lazyReRender();},unSelect:function(_20){var _21=this;dojo.query(_20).orphan().forEach(function(_22){_21.uninviteAppendNode(_22);var ctr=dojo.byId("invitedCounter");var _23=parseInt(ctr.innerHTML,10)-1;ctr.innerHTML=_23;if(_23===0){dojo.query("p.inviterTwo",_21.global_invited_node).removeClass("hidden");}});},toggle_mutuals:function(evt){this.mutuals=evt.target.checked;this.lazyReRender();},filter:function(evt){if(evt.keyCode==27){this.filterNode.value="";this.current_filter="";}else{if(evt.keyCode<45&&evt.keyCode!=8){return;}}this.current_filter=this.filterNode.value.toLowerCase();this.lazyReRender();},renderUserAndPlace:function(_24){dojo.place(ff.t.render(this.friends_template,_24),this.friendlist,"last");}});}