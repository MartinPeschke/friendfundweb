/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["friendfund.NetworkFriendSelector"]){dojo._hasResource["friendfund.NetworkFriendSelector"]=true;dojo.provide("friendfund.NetworkFriendSelector");dojo.provide("friendfund.FriendTypeAhead");dojo.require("friendfund.EmailFriendSelector");dojo.require("ff.t");dojo.require("ff.io");dojo.declare("friendfund.NetworkFriendPanel",friendfund._Selector,{constructor:function(_1){dojo.mixin(this,_1);},draw:function(){ff.io.xhrPost(this.base_url+"/"+this.network,{},dojo.hitch(this,"onLoad"));},onLoad:function(_2){dojo.place(_2.html,this.ref_node,"only");dojo.style(this.ref_node,"display","Block");},destroy:function(){dojo.forEach(this._listener_locals,dojo.disconnect);this._listener_locals=[];},select:function(_3){var _4=ff.t.findParent(_3.target,"invitee_row");if(_4){return this.onSelect(_4,_3);}}});dojo.declare("friendfund.DataProvider",friendfund.NetworkFriendPanel,{_selected:{},constructor:function(_5){dojo.mixin(this,_5);this._rendering=false;this._current_display_idx=0;this._fully_loaded=false;this._search_index={};},addToSearchIndex:function(ud){ud["dom_id"]=this.network+"_"+ud.network_id;var s,_6,i,j,k,_7,_8={};s=ud.name.split(" ").concat([ud.name]);for(i=0;i<s.length;i++){_6=s[i];for(j=0;j<=_6.length;j++){k=_6.substr(0,j).toLowerCase();_8[k]=true;}}for(k in _8){_7=this._search_index[k]||[];if(_7.push){_7.push(ud);this._search_index[k]=_7;}}if(this.current_filter.length&&_8[this.current_filter]){this.renderUserAndPlace(ud);}},_addPage:function(_9,_a){var i,ud;for(i=0;i<_9.length;i++){ud=_9[i];this.addToSearchIndex(ud);}this._fully_loaded=_a;},renderSlice:function(_b,_c){var _d=ff.t.render,_e=this.friends_template,_f=this._selected,_10=this.mutuals,si=this._search_index[this.current_filter||""]||[],_11=[],_12=[],len=si.length,i;for(i=this._current_display_idx;i<len;i++){if(!_f[si[i].dom_id]&&(!_10||_10&&si[i].mutual_with)){_11.push(si[i]);}if(_11.length<=_b){this._current_display_idx++;}}len=_11.length>_b?_b:_11.length;for(i=0;i<len;i++){_12.push(_d(_e,_11[i]));}if(_c){_12.push("<li id=\"loading_placeholder_"+this.network+"\" class=\"clear\">&nbsp;</li>");}return _12;},getFirstPage:function(){this._current_display_idx=0;return this.renderSlice(this._page_size,true);},getNextPage:function(){return this.renderSlice(this._page_size);},hasMoreFriends:function(){return !this._fully_loaded||this._current_display_idx<this._search_index[this.current_filter||""].length;},reRender:function(){var _13=this.getFirstPage();if(_13.length){dojo.place(_13.join(""),this.friendlist,"only");this.onResultsFound();}else{delete dojo.query("*",this.friendlist).orphan();this.onNoResultsFound();}},onResultsFound:function(){},onNoResultsFound:function(){},_checkScrollingState:function(evt){friendlist_loader=dojo.byId("loading_placeholder_"+this.network);if(!friendlist_loader){return;}var pos=dojo.position(friendlist_loader);if(pos.y<this.friendlist_box){if(this.hasMoreFriends()){dojo.place(this.getNextPage().join(""),friendlist_loader,"before");}}},renderUserAndPlace:function(_14){dojo.place(ff.t.render(this.friends_template,_14),this.friendlist,"last");},addLoad:function(_15){if(_15.friends){this._addPage(_15.friends,_15.is_complete);if(!_15.is_complete){ff.io.xhrPost(this.base_url+"/ext_"+this.network,{offset:_15.offset},dojo.hitch(this,"addLoad"));}}},draw:function(){if(this.rootNode){dojo.removeClass(this.rootNode,"hidden");this.connect();}else{if(!this.is_selected()||this._is_loading!==true){this._is_loading=true;var l=dojo.query("#networkinviter_"+this.network);if(l.length){l.orphan();}this.rootNode=dojo.create("DIV",{"id":("networkinviter_"+this.network)});dojo.byId(this.ref_node).appendChild(this.rootNode);dojo.place(this._loader,this.rootNode,"only");ff.io.xhrPost(this.base_url+"/"+this.network,{},dojo.hitch(this,"onLoad"));}}}});dojo.declare("friendfund.NetworkFriendSelector",friendfund.DataProvider,{rootNode:null,_is_loading:false,_page_size:20,current_filter:"",constructor:function(_16){dojo.mixin(this,_16);if(this.invited_node){this.invited_node=dojo.isString(this.invited_node)&&dojo.byId(this.invited_node)||this.invited_node;}else{this.invited_node=null;}_is_selected_decider=".methodselector.ajaxlink.selected[_type="+this.network+"]";this.lazyReRender=ff.t.debounce(dojo.hitch(this,"reRender"),200,false);this.checkScrollingState=ff.t.debounce(dojo.hitch(this,"_checkScrollingState"),100,false);},is_selected:function(){return dojo.query(this._is_selected_decider,this.container).length>0;},connect:function(){},undraw:function(){if(this.rootNode){dojo.addClass(this.rootNode,"hidden");}else{var l=dojo.query("#networkinviter_"+this.network);if(l.length){l.orphan();}}dojo.forEach(this._listener_locals,dojo.disconnect);this._listener_locals=[];},onLoad:function(_17){var _18=this;_18._is_loading=false;dojo.place(_17.html,_18.rootNode,"only");if(_17.success){_18.friendlist=dojo.byId("friend_list_"+_18.network);_18.friendlist_box=dojo.position(_18.friendlist.parentNode);_18.friendlist_box=_18.friendlist_box.h*2+_18.friendlist_box.y;var _19=dojo.byId("toggle_mutuals_"+_18.network);if(_19){dojo.connect(_19,"onclick",_18,"toggle_mutuals");_18.mutuals=_19.checked;}else{_18.mutuals=false;}_18.friends_template=_17.template;_18._addPage(_17.friends,_17.is_complete);_18.reRender();_18.filterNode=dojo.byId("filter_"+_18.network);dojo.connect(_18.friendlist,"onclick",_18,"select");dojo.connect(_18.filterNode,"onkeyup",_18,"filter");ff.w.parseDefaultsInputs(_18.ref_node);dojo.connect(_18.friendlist.parentNode,"onscroll",this.checkScrollingState);if(!_17.is_complete){ff.io.xhrPost(_18.base_url+"/ext_"+_18.network,{offset:_17.offset},dojo.hitch(_18,"addLoad"));}}else{dojo.query("a.facebookBtn",_18.rootNode).forEach(function(_1a){level=parseInt(dojo.attr(_1a,"_level"),10);dojo.connect(_1a,"onclick",dojo.hitch(_18.auth_provider,"doFBLogin",{level:level,success:dojo.hitch(_18,"draw")}));});dojo.query("a.twitterBtn",_18.rootNode).forEach(function(_1b){level=parseInt(dojo.attr(_1b,"_level"),10);dojo.connect(_1b,"onclick",dojo.hitch(_18.auth_provider,"doTWLogin",{level:level,success:dojo.hitch(_18,"draw")}));});_18.rootNode=null;}},onSelect:function(_1c,evt){this.checkScrollingState();dojo.query("p.inviterTwo",this.global_invited_node).addClass("hidden");this.inviteAppendNode(_1c);var el=dojo.byId("invitedCounter");el.innerHTML=parseInt(el.innerHTML,10)+1;},inviteAppendNode:function(_1d){var _1e=this;dojo.query(_1d).orphan().forEach(function(_1f){dojo.place(_1f,_1e.invited_node,"last");_1e._selected[_1f.id]=true;});},uninviteAppendNode:function(_20){delete this._selected[_20.id];this.lazyReRender();},unSelect:function(_21){var _22=this;dojo.query(_21).orphan().forEach(function(_23){_22.uninviteAppendNode(_23);var ctr=dojo.byId("invitedCounter");var _24=parseInt(ctr.innerHTML,10)-1;ctr.innerHTML=_24;if(_24===0){dojo.query("p.inviterTwo",_22.global_invited_node).removeClass("hidden");}});},toggle_mutuals:function(evt){this.mutuals=evt.target.checked;this.lazyReRender();},filter:function(evt){if(evt.keyCode==27){this.filterNode.value="";this.current_filter="";}else{if(evt.keyCode<45&&evt.keyCode!=8){return;}}this.current_filter=this.filterNode.value.toLowerCase();this.lazyReRender();}});dojo.declare("friendfund.FriendTypeAhead",friendfund.DataProvider,{rootNode:null,_is_loading:false,_page_size:5,current_filter:"",_has_results:false,selectedValueNode:"selectedReceiver",constructor:function(_25){dojo.mixin(this,_25);this._is_selected_decider=".methodselector.ajaxlink.selected[_type="+this.network+"]";this.lazyReRender=ff.t.debounce(dojo.hitch(this,"reRender"),100,false);this.mutuals=false;this.selectedValueNode=dojo.byId(this.selectedValueNode);this.checkScrollingState=ff.t.debounce(dojo.hitch(this,"_checkScrollingState"),100,false);},is_selected:function(){return dojo.query(this._is_selected_decider,this.container).length>0;},connect:function(){this._listener_locals.push(dojo.connect(this.friendlist,"onclick",this,"select"));this._listener_locals.push(dojo.connect(this.filterNode,"onkeyup",this,"filter"));this._listener_locals.push(dojo.connect(window,"onclick",this,"onHideSelector"));this._listener_locals.push(dojo.connect(this.filterNode,"onfocus",this,"onShowSelector"));this._listener_locals.push(dojo.connect(this.friendlist.parentNode,"onscroll",this.checkScrollingState));},onHideSelector:function(evt){if(!ff.t.findParent(evt.target,"typeAheadSelector")){this.hideSelector();}},hideSelector:function(){var pn=ff.t.findParent(this.friendlist,"friendsList");dojo.addClass(pn,"hidden");},onShowSelector:function(evt){evt.target.select();this.reRender();var tmp=dojo.position(this.friendlist.parentNode);this.friendlist_box=this.friendlist_box||tmp.y+tmp.h*1.5;},showSelector:function(){if(this._has_results){var pn=ff.t.findParent(this.friendlist,"friendsList");dojo.removeClass(pn,"hidden");}},undraw:function(){if(this.rootNode){dojo.addClass(this.rootNode,"hidden");}else{var l=dojo.query("#networkinviter_"+this.network);if(l.length){l.orphan();}}dojo.forEach(this._listener_locals,dojo.disconnect);this._listener_locals=[];},onLoad:function(_26){var _27=this;_27._is_loading=false;dojo.place(_26.html,_27.rootNode,"only");if(_26.success){_27.friendlist=dojo.byId("friend_list_"+_27.network);_27.friends_template=_26.template;_27._addPage(_26.friends,_26.is_complete);_27.filterNode=dojo.byId("filter_"+_27.network);ff.w.parseDefaultsInputs(_27.ref_node);_27.connect();if(!_26.is_complete){ff.io.xhrPost(_27.base_url+"/ext_"+_27.network,{offset:_26.offset},dojo.hitch(_27,"addLoad"));}}else{dojo.query("a.facebookBtn",_27.rootNode).forEach(function(_28){level=parseInt(dojo.attr(_28,"_level"),10);dojo.connect(_28,"onclick",dojo.hitch(_27.auth_provider,"doFBLogin",{level:level,success:dojo.hitch(_27,"draw")}));});dojo.query("a.twitterBtn",_27.rootNode).forEach(function(_29){level=parseInt(dojo.attr(_29,"_level"),10);dojo.connect(_29,"onclick",dojo.hitch(_27.auth_provider,"doTWLogin",{level:level,success:dojo.hitch(_27,"draw")}));});_27.rootNode=null;}},onResultsFound:function(){this._has_results=true;this.showSelector();},onNoResultsFound:function(){this._has_results=false;this.hideSelector();},onSelect:function(_2a,evt){this.inviteAppendNode(_2a);},inviteAppendNode:function(_2b){var _2c=this;var pn=ff.t.findParent(_2c.friendlist,"typeAheadSelector");dojo.query("img.smallProfPic",pn).orphan();dojo.query("img",_2b).forEach(function(n){var _2d=dojo.create("IMG",{src:n.src,className:"smallProfPic"});dojo.place(_2d,pn,"first");});var _2e=dojo.query("input",_2b);if(_2e.length){_2c.selectedValueNode.value=_2e[0].value;}_2c.filterNode.value=dojo.query("p",_2b).attr("innerHTML").join("");_2c.current_filter=_2c.filterNode.value.toLowerCase();dojo.query(_2c.filterNode).removeClass("default").addClass("selected");_2c.reRender();_2c.onNoResultsFound();},uninviteAppendNode:function(_2f){},unSelect:function(_30){},filter:function(evt){if(evt.keyCode==27){this.filterNode.value="";this.current_filter="";}else{if(evt.keyCode<45&&evt.keyCode!=8){return;}}this.current_filter=this.filterNode.value.toLowerCase();this.lazyReRender();}});}