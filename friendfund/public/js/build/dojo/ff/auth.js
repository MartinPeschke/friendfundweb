/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["ff.auth"]){dojo._hasResource["ff.auth"]=true;dojo.provide("ff.auth");dojo.require("ff.t");dojo.require("ff.Popup");dojo.declare("ff._auth",null,{timeoutValue:500,_FBSCOPE:{"3":"email","6":"email,publish_stream","9":"email,publish_stream,create_event,user_birthday,friends_birthday"},_get_scope:function(_1){return this._FBSCOPE[""+(_1.level||3)];},_facebook_login_in_process:false,_twitter_login_in_process:false,_fbperms:null,_loginPanelContainer:"accountcontainer",_loginPanelForm:"loginPanelContent",_loginPanelHandler:[],_workflow:{success:null,fail:null},_fwd:function(){window.location.href="/mypools/stream";},fwd:false,_rld:ff.t.reload,rld:false,hasLoginPanel:true,isLoggedIn:function(){return !dojo.byId("loginlink");},constructor:function(){},_fbInit:function(_2,_3){var _4=this,_5=new ff.t.deferreds(function(){return this.fbDoneLoading;},this),_6=new ff.t.deferreds(function(){return this.fbDoneLoading&&typeof (FB)!=="undefined"&&FB.getAuthResponse();},this);window.fbAsyncInit=function(){var _7=document.location.protocol+"//"+document.location.host+"/channel.htm";FB.init({appId:_2,logging:true,status:true,cookie:true,xfbml:true,authResponse:true,channelUrl:_7});FB.Event.subscribe("auth.authResponseChange",dojo.hitch(_4,"_onSessionChange"));_4.fbDoneLoading=true;_4.runFBDeferred();if(FB.getAuthResponse()){_4.runLoginDeferred();}};this.addFBDeferred=_5.add;this.runFBDeferred=_5.run;this.addLoginDeferred=_6.add;this.runLoginDeferred=_6.run;if(this.requireFBPerms){this.addLoginDeferred(dojo.hitch(this,"_guardedFBScope"));}var js,id="facebook-jssdk";if(document.getElementById(id)){return;}js=document.createElement("script");js.id=id;js.async=true;js.src="//connect.facebook.net/en_US/all.js";document.getElementsByTagName("body")[0].appendChild(js);},_loginPanelFormConnect:function(){var _8=this;dojo.forEach(_8._loginPanelHandler,dojo.disconnect);_8._loginPanelHandler=[];dojo.query("form",_8._loginPanelContainer).forEach(function(_9){_8._loginPanelHandler.push(dojo.connect(_9,"onsubmit",_8,"emailLogin"));});},_connectLoginPanel:function(){var _a=this,_b=[],_c=[],_d=[],_e=function(){dojo.forEach(_b,dojo.disconnect);_b=[];dojo.forEach(_c,dojo.unsubscribe);_c=[];if(dojo.hasClass("loginlink","active")){dojo.removeClass("loginlink","active");if(dojo.byId(_a._loginPanelForm)){dojo.addClass(_a._loginPanelForm,"hidden");}}},_f=function(evt){if(!dojo.hasClass(this,"active")){dojo.addClass(this,"active");dojo.removeClass(_a._loginPanelForm,"hidden");_b.push(dojo.connect(document,"onkeydown",function(evt){if(evt.keyCode==27){_e(evt);}}));_b.push(dojo.connect(document,"onclick",function(evt){if(!(evt.target.id=="loginlink")&&!ff.t.findParent(evt.target,"loginPanel")){_e(evt);}}));_c.push(dojo.subscribe("/ff/login/panel/close",_e));_a._loginPanelFormConnect();var i=dojo.query("input",_a._loginPanelForm);i[0].focus();}else{if(evt.target.id=="loginlink"){_e();}}},_10=function(){dojo.forEach(_d,dojo.disconnect);_d=[];dojo.query(".loginToggleLink",_a._loginPanelContainer).forEach(function(_11){_d.push(dojo.connect(_11,"onclick",_f));});dojo.query(".logoutLink",_a._loginPanelContainer).forEach(function(_12){_d.push(dojo.connect(_12,"onclick",_a,"logout",true));});dojo.subscribe("/ff/login/panel/reconnect",_10);};_10();},_simpleLogout:function(){if(this.isLoggedIn()){window.location.href="/logout?furl=/";}},_guardedFBScope:function(_13){var _14=this,aR=FB.getAuthResponse();if(aR&&aR!==true){this._getFBScope(_13);}else{FB.getLoginStatus(function(_15){_14._getFBScope(_13);});}},_getFBScope:function(_16){var _17=this;FB.api("/me/permissions",function(_18){if(!_18.error){_17._fbperms=_18.data[0];}if(_16){_16.apply(_17);}});},_onSessionChange:function(_19){var _1a=this;if(_19.status==="connected"){var aR=_19.authResponse;if(_1a.fbId&&aR.userID!=_1a.fbId){_1a._simpleLogout();}else{if(!_1a._fb_login_in_progress){_1a._fbHandleLogin(_1a._get_scope(_1a._workflow));}else{_1a._fb_login_in_progress=false;}}}else{_1a._simpleLogout();}},_forceFBLogin:function(_1b){var _1c=this;_1c._fb_login_in_progress=true;FB.login(function(_1d){if(_1d.authResponse){_1c._guardedFBScope(dojo.hitch(_1c,"_fbHandleLogin",_1b));}},{scope:_1b});},_getMissingFBPerms:function(_1e){if(!this._fbperms){return [];}var mp=_1e.split(","),_1f=[],_20=_20||{},i=0,l=mp.length;for(;i<l;i++){if(!this._fbperms[mp[i]]){_1f.push(mp[i]);}}return _1f;},_checkFBIsInOrder:function(_21){var _22=this;if(this.fbId){FB.getLoginStatus(function(){var mp=_22._getMissingFBPerms(_21);if(mp.length){_22._forceFBLogin(_21);}else{_22._logincb({success:true});}});}else{_22._logincb({success:true});}},_fbHandleLogin:function(_23){var _24=this,mp=_24._getMissingFBPerms(_23),_25={};if(mp.length){_25.scope=ff.t.getKeys(_24._fbperms).join(",");_25.missing_scope=mp.join(",");_25.access_token=FB.getAuthResponse().accessToken;ff.io.xhrPost("/fb/failed_login",_25,dojo.hitch(_24,"_logincb"));}else{FB.api("/me",function(_26){_26.scope=ff.t.getKeys(_24._fbperms).join(",");_26.access_token=FB.getAuthResponse().accessToken;ff.io.xhrPost("/fb/login",_26,dojo.hitch(_24,"_logincb"));});}},_logincb:function(_27){var _28=this,i,_29,_2a=_28._get_scope(_28._workflow),_2b=[],_2c=function(){ff.io.xhrFormPost(this.action,this,dojo.hitch(_28,"_logincb"));return false;},_2d=function(evt){var _2e=dojo.attr(evt.target,"_href");ff.io.xhrPost(_2e,{},dojo.hitch(_28,"_logincb"));return false;};_29=_28._workflow._login_popup;if(_29){delete _29.afterClose;_29.destroy();}if(_27.panel!==undefined&&dojo.byId(_28._loginPanelContainer)){dojo.place(_27.panel,_28._loginPanelContainer,"only");dojo.publish("/ff/login/panel/reconnect");}else{if(_27.form&&dojo.byId(_28._loginPanelForm)){dojo.place(_27.form,dojo.byId(_28._loginPanelForm),"only");if(this.hasLoginPanel){_28._loginPanelFormConnect();}i=dojo.query("input",_28._loginPanelForm);if(i.length>0){i[0].focus();}}}if(_27.popup!==undefined){_29=new ff.Popup();_29.afterDisplay=function(_2f){var _30=this;dojo.query("form.loginAction",_2f).forEach(function(_31){_31.onsubmit=_2c;});dojo.query("a.loginAction",_2f).forEach(function(_32){_30._handler.push(dojo.connect(_32,"onclick",_2d));});if(dojo.byId("ToC-agreeal-popup")){_28.connectToCToggle("ToC-agreeal-popup","ToC-checkbox-popup");}else{dojo.query("a.loginFBAction",_2f).forEach(function(_33){_30._handler.push(dojo.connect(_33,"onclick",dojo.hitch(_28,"doFBLogin",_28._workflow)));});dojo.query("a.loginTWAction",_2f).forEach(function(_34){_30._handler.push(dojo.connect(_34,"onclick",dojo.hitch(_28,"doTWLogin",_28._workflow)));});}};_29.afterClose=function(_35){_28._workflow.fail&&_28._workflow.fail();_28._workflow={};};_29.display(_27.popup);_28._workflow._login_popup=_29;}else{if(_27.success===true&&_28._workflow.success!=null){_28._workflow.success(_27);_28._workflow={};}else{if(_27.success===false&&_28._workflow.fail!=null){_28._workflow.fail(_27);_28._workflow={};}else{if(_27.has_activity===true&&_28.fwd===true){_28._fwd(_27);_28._workflow={};}else{if(_27.success===true&&_28.rld===true){_28._rld(_27);_28._workflow={};}else{if(_27.reload===true){window.location.href=window.location.href;_28._workflow={};}}}}}}}});dojo.declare("ff.auth",[ff._auth],{constructor:function(_36,_37){dojo.mixin(this,_36);if(_37&&typeof (_37)==="object"){dojo.mixin(this,_37);}if(this.hasLoginPanel){this._connectLoginPanel();}this._fbInit(_36.fbappId,_36.fbRootNode);this._fb_login_in_progress=false;},checkLogin:function(_38){this._workflow.level=_38.level||3;var url=_38.url||this.loginurl,_39=this._get_scope(this._workflow);if(_38.success||_38.fail){this._workflow.success=_38.success;this._workflow.fail=_38.fail;}if(this.isLoggedIn()){if(_38.ignoreFB){this._logincb({success:true});}else{this._checkFBIsInOrder(_39);}}else{ff.io.xhrPost(url,{level:this._workflow.level},dojo.hitch(this,"_logincb"));}return false;},emailLogin:function(evt){ff.io.xhrFormPost(evt.target.action,evt.target,dojo.hitch(this,"_logincb"));evt.stopPropagation();evt.preventDefault();return false;},forgotPassword:function(url){dojo.publish("/ff/login/panel/close");ff.io.xhrPost(url,{},dojo.hitch(this,"_logincb"));},signupPopup:function(url,_3a){dojo.publish("/ff/login/panel/close");ff.io.xhrPost(url,{level:_3a},dojo.hitch(this,"_logincb"));},logout:function(_3b){if(this.isLoggedIn()){FB.getLoginStatus(function(_3c){if(_3c.session){FB.logout(function(){window.location.href="/logout?furl=/";});}else{window.location.href="/logout?furl=/";}});}},doFBLogin:function(_3d){var _3e=this;dojo.mixin(_3e._workflow,_3d);if(_3e._facebook_login_in_process===false){_3e._facebook_login_in_process=true;setTimeout(function(){_3e._facebook_login_in_process=false;},_3e.timeoutValue);var _3f=_3e._get_scope(_3e._workflow);if(_3d.success||_3d.fail){_3e._workflow.success=_3d.success;_3e._workflow.fail=_3d.fail;}var aR=FB.getAuthResponse();if(aR){FB.api("/me",function(_40){FB.api("/me/permissions",function(_41){_40.scope=ff.t.getKeys(_41.data[0]).join(",");_40.access_token=aR.accessToken;_40.expires=aR.expiresIn;ff.io.xhrPost("/fb/login",_40,dojo.hitch(_3e,"_logincb"));});});}else{_3e._forceFBLogin(_3f);}}},doTWLogin:function(_42){this._workflow.level=_42.level||3;if(_42.success||_42.fail){this._workflow.success=_42.success;this._workflow.fail=_42.fail;}var _43=this;if(_43._twitter_login_in_process===false){_43._twitter_login_in_process=true;setTimeout(function(){_43._twitter_login_in_process=false;},_43.timeoutValue);var _44=window.location.protocol+"//"+window.location.host;_43._twitterAction_=_43._workflow.success;window.open(_44+"/twitter/login","_blank","left=100,top=100,height=480,width=850,location=no,resizable=yes,scrollbars=yes");}},connectToCToggle:function(_45,_46){var _47=function(){dojo.query(".error",_45).removeClass("hidden");},_48=function(){dojo.query(".error",_45).addClass("hidden");},_49=[];dojo.query("input",_45).connect("change",function(e){if(e.target.checked){_48();}});dojo.query(".facebookBtn",_45).forEach(function(_4a){_49.push(dojo.connect(_4a,"click",function(e){if(!dojo.byId(_46).checked){_47();}else{_48();return window.__auth__.doFBLogin({success:ff.t.goto_url_or_reload(this)});}}));});dojo.query(".twitterBtn",_45).forEach(function(_4b){_49.push(dojo.connect(_4b,"click",function(e){if(!dojo.byId(_46).checked){_47();}else{_48();dojo.forEach(_49,dojo.disconnect);return window.__auth__.doTWLogin({success:ff.t.goto_url_or_reload(this)});}}));});}});}