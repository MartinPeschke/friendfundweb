/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["ff.auth"]){dojo._hasResource["ff.auth"]=true;dojo.provide("ff.auth");dojo.require("ff.Popup");String.prototype.strip=function(ch){var re=new RegExp("^"+ch+"+|"+ch+"+$","g");return String(this).replace(re,"");};dojo.declare("ff._auth",null,{timeoutValue:500,_FBSCOPE:{"3":"email","6":"email,publish_stream","9":"email,publish_stream,create_event,user_birthday,friends_birthday"},_get_scope:function(_1){return this._FBSCOPE[""+(_1.level||3)];},_facebook_login_in_process:false,_twitter_login_in_process:false,_fbperms:null,_loginPanelContainer:"accountcontainer",_loginPanelForm:"loginPanelContent",_loginPanelHandler:[],_workflow:{success:null,fail:null},_fwd:function(){window.location.href="/mypools/stream";},fwd:false,_rld:ff.t.reload,rld:false,hasLoginPanel:true,isLoggedIn:function(){return !dojo.byId("loginlink");},constructor:function(){},_fbInit:function(_2,_3){var _4=this;window.fbAsyncInit=function(){var _5=document.location.protocol+"//"+document.location.host+"/channel.htm";FB.init({appId:_2,status:true,cookie:true,xfbml:true,channelUrl:_5});FB.Event.subscribe("auth.sessionChange",dojo.hitch(_4,"_onSessionChange"));if(_4.requireFBPerms){_4._getLoginStatus();}};var e=document.createElement("script");e.src=document.location.protocol+"//connect.facebook.net/en_US/all.js";e.async=true;document.getElementById(_3).appendChild(e);},_loginPanelFormConnect:function(){var _6=this;dojo.forEach(_6._loginPanelHandler,dojo.disconnect);_6._loginPanelHandler=[];dojo.query("form",_6._loginPanelContainer).forEach(function(_7){_6._loginPanelHandler.push(dojo.connect(_7,"onsubmit",_6,"emailLogin"));});},_connectLoginPanel:function(){var _8=this,_9=[],_a=[],_b=[],_c=function(){dojo.forEach(_9,dojo.disconnect);_9=[];dojo.forEach(_a,dojo.unsubscribe);_a=[];if(dojo.hasClass("loginlink","active")){dojo.removeClass("loginlink","active");if(dojo.byId(_8._loginPanelForm)){dojo.addClass(_8._loginPanelForm,"hidden");}}},_d=function(_e){if(!dojo.hasClass(this,"active")){dojo.addClass(this,"active");dojo.removeClass(_8._loginPanelForm,"hidden");_9.push(dojo.connect(document,"onkeydown",function(_f){if(_f.keyCode==27){_c(_f);}}));_9.push(dojo.connect(document,"onclick",function(evt){if(!(evt.target.id=="loginlink")&&!ff.t.findParent(evt.target,"loginPanel")){_c(evt);}}));_a.push(dojo.subscribe("/ff/login/panel/close",_c));_8._loginPanelFormConnect();var i=dojo.query("input",_8._loginPanelForm);i[0].focus();}else{if(_e.target.id=="loginlink"){_c();}}},_10=function(){dojo.forEach(_b,dojo.disconnect);_b=[];dojo.query(".loginToggleLink",_8._loginPanelContainer).forEach(function(_11){_b.push(dojo.connect(_11,"onclick",_d));});dojo.query(".logoutLink",_8._loginPanelContainer).forEach(function(_12){_b.push(dojo.connect(_12,"onclick",_8,"logout",true));});dojo.subscribe("/ff/login/panel/reconnect",_10);};_10();},_simpleLogout:function(){if(this.isLoggedIn()){window.location.href="/logout?furl=/";}},_onSessionChange:function(_13){var _14=this;if(_13.status==="connected"){var _15=_13.session;if(_14.fbId&&_15.uid!=_14.fbId){_14._simpleLogout();}else{if(!_14._fb_login_in_progress){_14._getLoginStatus(dojo.hitch(_14,"_fbHandleLogin",_14._get_scope(_14._workflow),_13));}else{_14._fb_login_in_progress=false;}}}else{_14._simpleLogout();}},_getLoginStatus:function(_16){var _17=this,_16=_16;FB.getLoginStatus(function(_18){_17._fbperms=ff.t.toMap(ff.t.getValues(dojo.fromJson(_18.perms)).join(",").split(","));_16&&_16.apply(_17,[_18].concat(arguments));},true);},_forceFBLogin:function(_19){var _1a=this;_1a._fb_login_in_progress=true;FB.login(function(_1b){if(_1b.status=="connected"){_1a._getLoginStatus(dojo.hitch(_1a,"_fbHandleLogin",_19,_1b));}},{perms:_19});},_getFBPerms:function(cb,_1c){var _1d=this;if(!_1d._fbperms){session=FB.getSession();if(session&&session.uid){_1d._getLoginStatus(cb);}else{_1c&&_1c();}}else{cb&&cb.apply(_1d,[_1d._fbperms]);}},_getMissingFBPerms:function(_1e,_1f){var mp=_1e.split(","),_20=[],_1f=_1f||{};for(var i=0;i<mp.length;i++){if(!_1f[mp[i]]){_20.push(mp[i]);}}return _20;},_checkFBIsInOrder:function(_21,_22){var _23={},_24=this,_25=FB.getSession();if(this.fbId&&_25){_24._getFBPerms(function(_26){var mp=_24._getMissingFBPerms(_21,_24._fbperms);if(mp.length&&_22>3){_24._forceFBLogin(_21);}else{_24._logincb({success:true});}});}else{_24._logincb({success:true});}},_fbHandleLogin:function(_27,_28){var _29=this,_2a,i,_2b,a,_28={};var mp=_29._getMissingFBPerms(_27,_29._fbperms);if(mp.length){_28.scope=ff.t.getKeys(_29._fbperms).join(",");_28.missing_scope=mp.join(",");ff.io.xhrPost("/fb/failed_login",_28,dojo.hitch(_29,"_logincb"));}else{FB.api("/me",function(_2c){_2c.scope=ff.t.getKeys(_29._fbperms).join(",");_2c.fbsession=dojo.toJson(FB.getSession());ff.io.xhrPost("/fb/login",_2c,dojo.hitch(_29,"_logincb"));});}},_logincb:function(_2d){var _2e=this,i,_2f,_30=_2e._get_scope(_2e._workflow),_31=[],_32=function(){ff.io.xhrFormPost(this.action,this,dojo.hitch(_2e,"_logincb"));return false;},_33=function(evt){var _34=dojo.attr(evt.target,"_href");ff.io.xhrPost(_34,{},dojo.hitch(_2e,"_logincb"));return false;};_2f=_2e._workflow._login_popup;if(_2f){delete _2f.afterClose;_2f.destroy();}if(_2d.panel!==undefined&&dojo.byId(_2e._loginPanelContainer)){dojo.place(_2d.panel,_2e._loginPanelContainer,"only");dojo.publish("/ff/login/panel/reconnect");}else{if(_2d.form&&dojo.byId(_2e._loginPanelForm)){dojo.place(_2d.form,dojo.byId(_2e._loginPanelForm),"only");if(this.hasLoginPanel){_2e._loginPanelFormConnect();}i=dojo.query("input",_2e._loginPanelForm);if(i.length>0){i[0].focus();}}}if(_2d.popup!==undefined){_2f=new ff.Popup();_2f.afterDisplay=function(_35){var _36=this;dojo.query("form.loginAction",_35).forEach(function(_37){_37.onsubmit=_32;});dojo.query("a.loginAction",_35).forEach(function(_38){_36._handler.push(dojo.connect(_38,"onclick",_33));});dojo.query("a.loginFBAction",_35).forEach(function(_39){_36._handler.push(dojo.connect(_39,"onclick",dojo.hitch(_2e,"doFBLogin",_2e._workflow)));});dojo.query("a.loginTWAction",_35).forEach(function(_3a){_36._handler.push(dojo.connect(_3a,"onclick",dojo.hitch(_2e,"doTWLogin",_2e._workflow)));});};_2f.afterClose=function(_3b){_2e._workflow.fail&&_2e._workflow.fail();_2e._workflow={};};_2f.display(_2d.popup);_2e._workflow._login_popup=_2f;}else{if(_2d.success===true&&_2e._workflow.success!=null){_2e._workflow.success(_2d);_2e._workflow={};}else{if(_2d.success===false&&_2e._workflow.fail!=null){_2e._workflow.fail(_2d);_2e._workflow={};}else{if(_2d.has_activity===true&&_2e.fwd===true){_2e._fwd(_2d);_2e._workflow={};}else{if(_2d.success===true&&_2e.rld===true){_2e._rld(_2d);_2e._workflow={};}else{if(_2d.reload===true){window.location.href=window.location.href;_2e._workflow={};}}}}}}}});dojo.declare("ff.auth",[ff._auth],{constructor:function(_3c,_3d){dojo.mixin(this,_3c);if(_3d&&typeof (_3d)==="object"){dojo.mixin(this,_3d);}if(this.hasLoginPanel){this._connectLoginPanel();}this._fbInit(_3c.fbappId,_3c.fbRootNode);this._fb_login_in_progress=false;},checkLogin:function(_3e){var _3f=this;this._workflow.level=_3e.level||3;var url=_3e.url||this.loginurl,_40=_3f._get_scope(_3f._workflow);if(_3e.success||_3e.fail){this._workflow.success=_3e.success;this._workflow.fail=_3e.fail;}if(this.isLoggedIn()){if(_3e.ignoreFB){_3f._logincb({success:true});}else{_3f._checkFBIsInOrder(_40,_3f._workflow.level);}}else{ff.io.xhrPost(url,{level:this._workflow.level},dojo.hitch(this,"_logincb"));}return false;},emailLogin:function(evt){ff.io.xhrFormPost(evt.target.action,evt.target,dojo.hitch(this,"_logincb"));evt.stopPropagation();evt.preventDefault();return false;},forgotPassword:function(url){dojo.publish("/ff/login/panel/close");ff.io.xhrPost(url,{},dojo.hitch(this,"_logincb"));},logout:function(_41){if(this.isLoggedIn()){FB.getLoginStatus(function(_42){if(_42.session){FB.logout(function(){window.location.href="/logout?furl=/";});}else{window.location.href="/logout?furl=/";}});}},doFBLogin:function(_43){var _44=this;dojo.mixin(_44._workflow,_43);if(_44._facebook_login_in_process===false){_44._facebook_login_in_process=true;setTimeout(function(){_44._facebook_login_in_process=false;},_44.timeoutValue);var _45=_44._get_scope(_44._workflow);if(_43.success||_43.fail){_44._workflow.success=_43.success;_44._workflow.fail=_43.fail;}_44._getFBPerms(function(_46){var mp=_44._getMissingFBPerms(_45,_46);if(mp.length){_44._forceFBLogin(_45);}else{FB.api("/me",function(_47){_47.scope=ff.t.getKeys(_46).join(",");_47.fbsession=dojo.toJson(FB.getSession());ff.io.xhrPost("/fb/login",_47,dojo.hitch(_44,"_logincb"));});}},function(){_44._forceFBLogin(_45);});}},doTWLogin:function(_48){this._workflow.level=_48.level||3;if(_48.success||_48.fail){this._workflow.success=_48.success;this._workflow.fail=_48.fail;}var _49=this;if(_49._twitter_login_in_process===false){_49._twitter_login_in_process=true;setTimeout(function(){_49._twitter_login_in_process=false;},_49.timeoutValue);var _4a=window.location.protocol+"//"+window.location.host;_49._twitterAction_=_49._workflow.success;window.open(_4a+"/twitter/login","_blank","left=100,top=100,height=400,width=850,location=no,resizable=yes,scrollbars=yes");}}});}