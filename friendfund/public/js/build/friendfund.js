/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/

if(!dojo._hasResource["friendfund.EmailFriendSelector"]){dojo._hasResource["friendfund.EmailFriendSelector"]=true;dojo.provide("friendfund.EmailFriendSelector");dojo.declare("friendfund._Selector",null,{_listener_locals:[],_loader:"<div style=\"margin: 0px auto;text-align:center;padding:30px;\"><div class=\"loading_animation\"><img src=\"/static/imgs/ajax-loader.gif\"></div></div>",draw:function(){},destoy:function(){},uninviteAppendNode:function(_1){},inviteAppendNode:function(_2){}});dojo.declare("friendfund.YourselfSelector",friendfund._Selector,{constructor:function(_3){dojo.mixin(this,_3);this.ref_node=dojo.isString(this.ref_node)&&dojo.byId(this.ref_node)||this.ref_node;},draw:function(){ff.io.xhrPost(this.base_url+"/validate",{"invitee.network":"yourself"},dojo.hitch(this,"_onSelect"));},_onSelect:function(_4){if(_4.success===true){this.onSelect(_4,_4.html,null);}else{dojo.place(_4.html,this.ref_node,"only");}},onSelect:function(_5,_6,_7){},undraw:function(){},destroy:function(){}});dojo.declare("friendfund.EmailFriendSelector",friendfund._Selector,{_listener_locals:[],rootNode:null,constructor:function(_8){dojo.mixin(this,_8);this.ref_node=dojo.isString(this.ref_node)&&dojo.byId(this.ref_node)||this.ref_node;},draw:function(){if(this.rootNode){dojo.removeClass(this.rootNode,"hidden");dojo.query("input[type=text]",this.rootNode)[0].focus();}else{this.rootNode=dojo.create("DIV",{"id":("networkinviter_"+this.network)});dojo.byId(this.ref_node).appendChild(this.rootNode);dojo.place(this._loader,this.rootNode,"only");ff.io.xhrPost(this.base_url+"/"+this.network,{},dojo.hitch(this,"onLoad"));}},onLoad:function(_9){dojo.place(_9,this.rootNode,"only");this._listener_locals.push(dojo.connect(this.ref_node,"onclick",this,"selectClick"));this._listener_locals.push(dojo.connect(this.ref_node,"onkeydown",dojo.hitch(this,ff.t.accessability,dojo.hitch(this,"select"),function(){})));ff.w.parseDefaultsInputs(this.rootNode);dojo.query("input[type=text]",this.rootNode)[0].focus();},undraw:function(){dojo.addClass(this.rootNode,"hidden");},destroy:function(){dojo.forEach(this._listener_locals,dojo.disconnect);this._listener_locals=[];},selectClick:function(_a){if(_a.target.id==="emailsubmitter"){this.select(_a);}},select:function(_b){var _c=dojo.byId("email_email");if(_c&&_c.value.length>0){ff.io.xhrFormPost(this.base_url+"/validate","emailinviter",dojo.hitch(this,"_onSelect"));}},_onSelect:function(_d){if(_d.success===true){this.onSelect(_d.html,null);dojo.place(_d.input_html,this.rootNode,"only");}else{dojo.place(_d.html,this.rootNode,"only");}var _e=dojo.query("input[type=text]",this.rootNode)[0];ff.w.parseDefaultsInputs(this.rootNode);if(_e){_e.focus();}},inviteAppendNode:function(_f){dojo.place(_f,this.invited_node,"last");dojo.query("input[type=text]","emailinviter").attr("value","");dojo.query("#email_inviter_error","emailinviter").orphan();},onSelect:function(_10,evt){dojo.query("p.inviterTwo",this.global_invited_node).addClass("hidden");this.inviteAppendNode(_10);var el=dojo.byId("invitedCounter");el.innerHTML=parseInt(el.innerHTML,10)+1;},unSelect:function(_11){dojo.query(_11).orphan();elem=dojo.byId("invitedCounter");elem.innerHTML=parseInt(elem.innerHTML,10)-1;}});}if(!dojo._hasResource["friendfund.NetworkFriendSelector"]){dojo._hasResource["friendfund.NetworkFriendSelector"]=true;dojo.provide("friendfund.NetworkFriendSelector");dojo.declare("friendfund.NetworkFriendPanel",friendfund._Selector,{constructor:function(_12){dojo.mixin(this,_12);},draw:function(){ff.io.xhrPost(this.base_url+"/"+this.network,{},dojo.hitch(this,"onLoad"));},onLoad:function(_13){dojo.place(_13.html,this.ref_node,"only");dojo.style(this.ref_node,"display","Block");},destroy:function(){dojo.forEach(this._listener_locals,dojo.disconnect);this._listener_locals=[];},select:function(evt){var _14=ff.t.findParent(evt.target,"invitee_row");if(_14){this.checkScrollingState();return this.onSelect(_14,evt);}}});dojo.declare("friendfund.DataProvider",friendfund.NetworkFriendPanel,{constructor:function(_15){dojo.mixin(this,_15);this._rendering=false;this._current_display_idx=0;this._fully_loaded=false;this._search_index={};},addToSearchIndex:function(ud){ud["dom_id"]=this.network+"_"+ud.network_id;var s,_16,i,j,k,tmp,_17={};s=ud.name.split(" ").concat([ud.name]);for(i=0;i<s.length;i++){_16=s[i];for(j=0;j<=_16.length;j++){k=_16.substr(0,j).toLowerCase();_17[k]=true;}}for(k in _17){tmp=this._search_index[k]||[];if(tmp.push){tmp.push(ud);this._search_index[k]=tmp;}}if(this.current_filter.length&&_17[this.current_filter]){this.renderUserAndPlace(ud);}},_addPage:function(_18,_19){var i,ud;for(i=0;i<_18.length;i++){ud=_18[i];this.addToSearchIndex(ud);}this._fully_loaded=_19;},renderSlice:function(_1a,_1b){var _1c=ff.t.render,_1d=this.friends_template,sel=this._selected,_1e=this.mutuals,si=this._search_index[this.current_filter||""]||[],_1f=[],_20=[],len=si.length,i;for(i=this._current_display_idx;i<len;i++){if(!sel[si[i].dom_id]&&(!_1e||_1e&&si[i].mutual_with)){_1f.push(si[i]);}if(_1f.length<=_1a){this._current_display_idx++;}}len=_1f.length>_1a?_1a:_1f.length;for(i=0;i<len;i++){_20.push(_1c(_1d,_1f[i]));}if(_1b){_20.push("<li id=\"loading_placeholder_"+this.network+"\">&nbsp;</li>");}return _20;},getFirstPage:function(){this._current_display_idx=0;return this.renderSlice(this._page_size,true);},getNextPage:function(){return this.renderSlice(this._page_size);},hasMoreFriends:function(){return !this._fully_loaded||this._current_display_idx<this._search_index[this.current_filter||""].length;},reRender:function(){var _21=this.getFirstPage();if(_21.length){dojo.place(_21.join(""),this.friendlist,"only");}else{delete dojo.query("*",this.friendlist).orphan();}},_checkScrollingState:function(evt){friendlist_loader=dojo.byId("loading_placeholder_"+this.network);if(!friendlist_loader){return;}var pos=dojo.position(friendlist_loader);if(pos.y<friendlist_box){if(this.hasMoreFriends()){dojo.place(this.getNextPage().join(""),friendlist_loader,"before");}}}});dojo.declare("friendfund.NetworkFriendSelector",friendfund.DataProvider,{rootNode:null,_is_loading:false,_page_size:20,current_filter:"",_selected:{},constructor:function(_22){dojo.mixin(this,_22);if(this.invited_node){this.invited_node=dojo.isString(this.invited_node)&&dojo.byId(this.invited_node)||this.invited_node;}else{this.invited_node=null;}_is_selected_decider=".methodselector.ajaxlink.selected[_type="+this.network+"]";this.lazyReRender=ff.t.debounce(dojo.hitch(this,"reRender"),200,false);this.checkScrollingState=ff.t.debounce(dojo.hitch(this,"_checkScrollingState"),100,false);},is_selected:function(){return dojo.query(this._is_selected_decider,this.container).length>0;},draw:function(){if(this.rootNode){dojo.removeClass(this.rootNode,"hidden");}else{if(!this.is_selected()||this._is_loading!==true){this._is_loading=true;var l=dojo.query("#networkinviter_"+this.network);if(l.length){l.orphan();}this.rootNode=dojo.create("DIV",{"id":("networkinviter_"+this.network)});dojo.byId(this.ref_node).appendChild(this.rootNode);dojo.place(this._loader,this.rootNode,"only");ff.io.xhrPost(this.base_url+"/"+this.network,{},dojo.hitch(this,"onLoad"));}}},undraw:function(){if(this.rootNode){dojo.addClass(this.rootNode,"hidden");}else{var l=dojo.query("#networkinviter_"+this.network);if(l.length){l.orphan();}}dojo.forEach(this._listener_locals,dojo.disconnect);this._listener_locals=[];},onLoad:function(_23){var _24=this;_24._is_loading=false;dojo.place(_23.html,_24.rootNode,"only");if(_23.success){_24.friendlist=dojo.byId("friend_list_"+_24.network);friendlist_box=dojo.position(_24.friendlist);friendlist_box=friendlist_box.h*2+friendlist_box.y;_24.friends_template=_23.template;var _25=dojo.byId("toggle_mutuals_"+_24.network);if(_25){dojo.connect(_25,"onclick",_24,"toggle_mutuals");_24.mutuals=_25.checked;}else{_24.mutuals=false;}_24._addPage(_23.friends,_23.is_complete);_24.reRender();_24.filterNode=dojo.byId("filter_"+_24.network);dojo.connect(_24.friendlist,"onclick",_24,"select");dojo.connect(_24.filterNode,"onkeyup",_24,"filter");ff.w.parseDefaultsInputs(_24.ref_node);dojo.connect(_24.friendlist,"onscroll",this.checkScrollingState);if(!_23.is_complete){ff.io.xhrPost(_24.base_url+"/ext_"+_24.network,{offset:_23.offset},dojo.hitch(_24,"addLoad"));}}else{dojo.query("a.facebookBtn",_24.rootNode).forEach(function(_26){level=parseInt(dojo.attr(_26,"_level"),10);dojo.connect(_26,"onclick",dojo.hitch(_24.auth_provider,"doFBLogin",{level:level,success:dojo.hitch(_24,"draw")}));});dojo.query("a.twitterBtn",_24.rootNode).forEach(function(_27){level=parseInt(dojo.attr(_27,"_level"),10);dojo.connect(_27,"onclick",dojo.hitch(_24.auth_provider,"doTWLogin",{level:level,success:dojo.hitch(_24,"draw")}));});_24.rootNode=null;}},addLoad:function(_28){if(!!_28.friends){this._addPage(_28.friends,_28.is_complete);}if(!_28.is_complete){ff.io.xhrPost(this.base_url+"/ext_"+this.network,{offset:_28.offset},dojo.hitch(this,"addLoad"));}},onSelect:function(_29,evt){dojo.query("p.inviterTwo",this.global_invited_node).addClass("hidden");this.inviteAppendNode(_29);var el=dojo.byId("invitedCounter");el.innerHTML=parseInt(el.innerHTML,10)+1;},inviteAppendNode:function(_2a){var _2b=this;dojo.query(_2a).orphan().forEach(function(_2c){dojo.place(_2c,_2b.invited_node,"last");_2b._selected[_2c.id]=true;});},uninviteAppendNode:function(_2d){delete this._selected[_2d.id];this.lazyReRender();},unSelect:function(_2e){var _2f=this;dojo.query(_2e).orphan().forEach(function(_30){_2f.uninviteAppendNode(_30);var ctr=dojo.byId("invitedCounter");var _31=parseInt(ctr.innerHTML,10)-1;ctr.innerHTML=_31;if(_31===0){dojo.query("p.inviterTwo",_2f.global_invited_node).removeClass("hidden");}});},toggle_mutuals:function(evt){this.mutuals=evt.target.checked;this.lazyReRender();},filter:function(evt){if(evt.keyCode==27){this.filterNode.value="";this.current_filter="";}else{if(evt.keyCode<45&&evt.keyCode!=8){return;}}this.current_filter=this.filterNode.value.toLowerCase();this.lazyReRender();},renderUserAndPlace:function(_32){dojo.place(ff.t.render(this.friends_template,_32),this.friendlist,"last");}});}if(!dojo._hasResource["friendfund.CompoundFriendSelector"]){dojo._hasResource["friendfund.CompoundFriendSelector"]=true;dojo.provide("friendfund.CompoundFriendSelector");dojo.declare("friendfund.CompoundFriendSelector",null,{_widget_locals:[],_listener_locals:[],selectors:{},constructor:function(_33){var _34=this;dojo.mixin(_34,_33);if(_33.avail_selectors.facebook===true){_34.selectors.facebook=new friendfund.NetworkFriendSelector({container:_34.container,auth_provider:_34.auth_provider,ref_node:_34.ref_node,invited_node:"network"+_34.invited_node_suffix,global_invited_node:_34.global_invited_node,base_url:_34.base_url,network:"facebook"});}if(_33.avail_selectors.twitter===true){_34.selectors.twitter=new friendfund.NetworkFriendSelector({container:_34.container,auth_provider:_34.auth_provider,ref_node:_34.ref_node,invited_node:"network"+_34.invited_node_suffix,global_invited_node:_34.global_invited_node,base_url:_34.base_url,network:"twitter"});}if(_33.avail_selectors.email===true){_34.selectors.email=new friendfund.EmailFriendSelector({ref_node:_34.ref_node,auth_provider:_34.auth_provider,invited_node:"network"+_34.invited_node_suffix,global_invited_node:_34.global_invited_node,base_url:_34.base_url,network:"email"});}if(_33.avail_selectors.yourself===true){_34.selectors.yourself=new friendfund.YourselfSelector({base_url:_34.base_url,ref_node:"receiver_selector_container"});}for(var sel in _34.selectors){var s=_34.selectors[sel];if(_34.selectors.hasOwnProperty(sel)&&_34.selectors[sel]){if(_34.onSelect){s.onSelect=dojo.hitch(s,_34.onSelect);}if(_34.unSelect){s.unSelect=dojo.hitch(s,_34.unSelect);}_34._widget_locals.push(s);}}if(_34.invited_node_suffix){_34._listener_locals.push(dojo.connect(dojo.byId(_34.global_invited_node),"onclick",_34,"unselect"));}var _35=dojo.byId("removeall");if(_35){_34._listener_locals.push(dojo.connect(_35,"onclick",_34,"removeAll"));}},removeAll:function(){var _36=this;dojo.query(".invitee_row.selectable",_36.global_invited_node).forEach(function(_37){_36.selectors[dojo.attr(_37,"_network")].unSelect(_37);});},unselect:function(evt){var _38=ff.t.findParent(evt.target,"invitee_row");if(!_38||!dojo.hasClass(_38,"selectable")){return;}this.selectors[dojo.attr(_38,"_network")].unSelect(_38);},destroy:function(){dojo.forEach(this._listener_locals,dojo.disconnect);this._listener_locals=[];dojo.forEach(this._widget_locals,function(_39){_39.destroy();});this._widget_locals=[];},switchMethod:function(evt){var _3a=this;if(dojo.hasClass(evt.target,"selected")){return;}dojo.query(".ajaxlink.selected",_3a.container).forEach(function(_3b){dojo.removeClass(_3b,"selected");var _3c=_3a.selectors[dojo.attr(_3b,"_type")];if(_3c){_3c.undraw();}});dojo.addClass(evt.target,"selected");var _3d=_3a.selectors[dojo.attr(evt.target,"_type")];if(_3d){_3d.draw();}},draw:function(_3e){var _3f=this;_3f.selectors[_3e].draw();dojo.query(".ajaxlink",_3f.container).forEach(function(_40){_3f._listener_locals.push(dojo.connect(_40,"onclick",_3f,"switchMethod"));});}});}if(!dojo._hasResource["friendfund.InvitePage"]){dojo._hasResource["friendfund.InvitePage"]=true;dojo.provide("friendfund.InvitePage");dojo.declare("friendfund.InvitePage",null,{selector:null,_listener_locals:[],_widget_locals:[],submitting:false,constructor:function(_41){var _42=this;dojo.mixin(_42,_41);_42.selector=new friendfund.CompoundFriendSelector({auth_provider:_42.auth_provider,container:_42.container,ref_node:"inviter",invited_node_suffix:"_invitees",inviter_node:"friend_list",base_url:_42.base_url,global_invited_node:_42.invited_node,avail_selectors:{"facebook":true,"twitter":true,"email":true}});_42._widget_locals.push(_42.selector);dojo.connect(document,"onclick",dojo.hitch(null,_42.loadPreviewPopup,_42,_42.method));},loadPreviewPopup:function(_43,_44,evt){if(dojo.hasClass(evt.target,"message_preview")){dojo.query("input.addRefContent",_43.target_form).forEach(function(_45){_45.value=dojo.byId(dojo.attr(_45,"_source")).value;});params=dojo.formToObject(_43.target_form);params.method=dojo.attr(evt.target,"_method");ff.io.xhrPost(dojo.attr(evt.target,"_href"),params);}},prepareSubmit:function(_46,_47,evt){ff.t.onSubmitCleaner(_46.target_form);if(_46.submitting){return false;}_46.submitting=true;return _46.auth_provider.checkLogin({level:_47,success:dojo.hitch(_46,"_submit"),fail:function(){_46.submitting=false;}});},_submit:function(){var _48=this;dojo.forEach(_48._widget_locals,function(_49){_49.destroy(_49);});_48._widget_locals=[];_48.receiver_selectors={};dojo.query("input.addRefContent",_48.target_form).forEach(function(_4a){_4a.value=dojo.byId(dojo.attr(_4a,"_source")).value;});dojo.byId(_48.target_form).submit();}});}if(!dojo._hasResource["friendfund.PartnerPanel"]){dojo._hasResource["friendfund.PartnerPanel"]=true;dojo.provide("friendfund.PartnerPanel");dojo.declare("friendfund.PartnerPanel",null,{constructor:function(_4b){var _4c=this;dojo.mixin(_4c,_4b);_4c.triedSubmitting=false;_4c.target_form=dojo.isString(_4c.target_form)&&dojo.byId(_4c.target_form)||_4c.target_form;_4c.connect();_4c.load_receiver();},connect:function(){var _4d=this;if(dojo.byId("productSelector")){dojo.connect(dojo.byId("productSelector"),"onchange",dojo.hitch(_4d,_4d.swapProduct));}if(dojo.byId("occasionSelector")){dojo.connect(dojo.byId("occasionSelector"),"onchange",dojo.hitch(_4d,_4d.swapOccasionName));}dojo.connect(dojo.byId("occasionTyper"),"onkeyup",dojo.hitch(_4d,_4d.changeOccasionName));},changeOccasionName:function(evt){var _4e=this;if(evt.target.value){dojo.byId(dojo.attr(evt.target,"_target")).value=evt.target.value;}else{var _4f={target:dojo.byId("occasionSelector")};this.swapOccasionName(_4f);}_4e.check_occasion_name();},swapOccasionName:function(evt){var _50=this;var _51=evt.target.options[evt.target.selectedIndex];dojo.byId(dojo.attr(evt.target,"_name_target")).value=_51.value;dojo.byId(dojo.attr(evt.target,"_key_target")).value=dojo.attr(_51,"key");_50.check_occasion_name();},swapProduct:function(evt){var _52=evt.target.options[evt.target.selectedIndex];dojo.query(".selectedProduct","productArea").removeClass("selectedProduct").addClass("hidden");dojo.query("#product_"+dojo.attr(_52,"_guid")).addClass("selectedProduct").removeClass("hidden");},load_receiver:function(){var _53=this;_53.selector=new friendfund.CompoundFriendSelector({auth_provider:_53.auth_provider,container:_53.container,ref_node:"inviter",invited_node_suffix:"_invitees",inviter_node:"friend_list",base_url:_53.base_url,mutuals:false,global_invited_node:_53.invited_node,avail_selectors:{"facebook":true,"twitter":true,"email":true},onSelect:function(_54,evt){_53.selector.removeAll();this.inviteAppendNode(_54);dojo.addClass(_53.invited_node,"filled");_53.check_receiver();return true;},unSelect:function(_55){dojo.query("#"+_55.id,this.invited_node).orphan().forEach(dojo.hitch(this,"uninviteAppendNode"));dojo.removeClass(_53.invited_node,"filled");}});_53.selector.draw(_53.method);},submit:function(url,_56,evt){var _57=this;var _58=_57.checkCompleteness();if(!_58||_57.submitting){return false;}else{ff.t.onSubmitCleaner(_57.target_form);_57.submitting=true;return _57.auth_provider.checkLogin({level:_56,success:dojo.hitch(_57,"_submit",url),fail:function(){_57.submitting=false;}});}},_submit:function(url){var _59=this;dojo.query("input[type=submit]").attr("disabled","disabled");_59.target_form.action=url;_59.target_form.onsubmit=function(){};_59.target_form.submit();},checkCompleteness:function(){var _5a=this;return _5a.check_receiver()&&_5a.check_occasion_name();},check_receiver:function(_5b){if(dojo.query(".invitee_row","network_invitees").length!=1){dojo.query(".errorHook","receiverSelectorContainer").addClass("error");dojo.query(".errorMsgIframe","selectedReceiverContainer").removeClass("hidden");return false;}else{dojo.query(".errorHook","receiverSelectorContainer").removeClass("error");dojo.query(".errorMsgIframe","selectedReceiverContainer").addClass("hidden");return true;}},check_occasion_name:function(_5c){var _5d=dojo.byId("occasion_name");var _5e=ff.t.findParent(_5d,"generalBoxIframe");if(!_5d.value){dojo.query(".errorMsgIframe",_5e).removeClass("hidden");dojo.query("#yourOccasionSelector,#occasionSelectorContainer").addClass("error");return false;}else{dojo.query(".errorMsgIframe",_5e).addClass("hidden");dojo.query("#yourOccasionSelector,#occasionSelectorContainer").removeClass("error");return true;}}});}
