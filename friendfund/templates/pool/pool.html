<%inherit file="pool_master.html"/>

<%namespace name="links" file="../links.html"/>
<%namespace name="html" file="../widgets/html_elems.html"/>
<%namespace name="description" file="parts/description.html"/>
<%namespace name="settings_common" file="parts/settings.html"/>
<%def name="title()">${_("POOL_PAGE__TITLE_Pool")}</%def>

<%def name="fb_meta_tags()">
	<link rel="image_src" href="${request.qualified_host}${c.pool.receiver.get_profile_pic("POOL")}" />
	<link rel="image_src" href="${request.qualified_host}${c.pool.product.get_product_pic()}" />
	<link rel="image_src" href="${request.qualified_host}${c.pool.admin.get_profile_pic("POOL")}" />
	<link rel="image_src" href="${request.qualified_host}${c.pool.get_pool_picture_tiles("MYPOOLS")}" />
	<link rel="image_src" href="${request.qualified_host}${c.pool.get_pool_picture_tiles("RA")}" />
	
	<meta property="og:image" content="${request.qualified_host}${c.pool.get_pool_picture_tiles("MYPOOLS")}" />
	<meta property="og:image" content="${request.qualified_host}${c.pool.get_pool_picture_tiles("RA")}" />
	<meta property="og:image" content="${request.qualified_host}${c.pool.receiver.get_profile_pic("POOL")}" />
	<meta property="og:image" content="${request.qualified_host}${c.pool.product.get_product_pic()}" />
	<meta property="og:image" content="${request.qualified_host}${c.pool.admin.get_profile_pic("POOL")}" />
	
	<meta property="og:title" content="${_("POOL_PAGE_Gift Pool for %(receiver)s") % dict([("receiver",c.pool.receiver.name)])}" />
	<meta property="og:description" content="${c.pool.description}" />
	<meta property="og:type" content="product"/>
	<meta property="og:url" content="${url.current(protocol="http")}"/>
	<meta property="og:site_name" content="Friendfund"/>
	<meta property="fb:app_id" content="${app_globals.FbAppID}"/>
</%def>

<%def name="onloadscripts()">
	onLoadPagelets("lowerbody_container");
	dojo.query(".popuplink", "pool_pool_panel").onclick(dojo.hitch(null, loadPopup));
</%def>
<%def name="scripts()">
	<script type="text/javascript">var addthis_config = {"data_track_clickback":true};</script>
	<script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#username=friendfund"></script>
</%def>

<%def name="tabContainer()">
	%if c.pool.am_i_admin(c.user):
		${settings_common.render_tabs("pool", pool_url = c.pool.p_url)|n}
	%endif
	<div style="clear:both;"></div>
</%def>

<%def name="page_slogan()">
	<%
		locals = {'user_name':(c.user.name or c.pool.suspect and c.pool.suspect.name or ""), 
				'receiver_name':c.pool.receiver.name, 
				'occasion_name': c.pool.occasion.get_display_name(), 
				'admin_name':c.pool.admin.name, 
				'product_name':c.pool.product.get_display_name()}
	%>
	%if c.pool.is_funded():
		%if c.pool.am_i_admin(c.user):
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>Congratulations, this pool is now fully funded!") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_You can order the gift as soon as you have filled in shipping and billing addresses.") % locals|n}</div>
		%elif c.pool.am_i_contributor(c.user):
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>This pool is now fully funded!") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_Thanks for contributing towards %(receiver_name)s's %(occasion_name)s gift.") % locals|n}</div>
		%elif not c.user.is_anon:
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>This pool is now fully funded!") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_Create your own gift pool within minutes and share the costs with friends.") % locals|n}</div>
		%else:
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi! <br/>This pool is now fully funded!") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_Log in and create your own gift pool within minutes.") % locals|n}</div>
		%endif
	%elif c.pool.is_expired():
		%if c.pool.am_i_admin(c.user):
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>Oh no! This pool has expired without reaching its goal.") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_Visit the Pool Admin Page page to extend the deadline and remind your friends to chip in.") % locals|n}</div>
		%else:
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>Oh no! This pool has expired without reaching its goal.") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_It's up to %(admin_name)s to extend the deadline so %(receiver_name)s can still get a %(product_name)s.") % locals|n}</div>
		%endif
	%elif c.pool.is_secret and c.pool.am_i_member(c.user):
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>Don't tell, but you've been invited to chip in for a secret gift pool.") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_%(admin_name)s has created a secret gift pool for %(receiver_name)s's %(occasion_name)s and you've been invited to help purchase it.") % locals|n}</div>
	%else:
		%if c.user.is_anon:
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi!<br/>%(admin_name)s has created a gift pool for %(receiver_name)s's %(occasion_name)s gift, log in and help out!") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_Please log in to chip in for %(receiver_name)s's %(occasion_name)s gift.") % locals|n}</div>
		%elif c.pool.am_i_admin(c.user):
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>You have created a pool for %(receiver_name)s's %(occasion_name)s gift.") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_Edit pool settings any time by visiting the Pool Admin page.") % locals|n}</div>
		%elif c.pool.am_i_contributor(c.user):
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>You've already chipped in for %(receiver_name)s's %(occasion_name)s gift!") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_Chip in as often as you like and help make %(receiver_name)s's day extra special!") % locals|n}</div>
		%elif c.pool.am_i_member(c.user):
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>You've been invited to chip in for %(receiver_name)s's %(occasion_name)s gift.") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_%(admin_name)s wants to get a %(product_name)s for %(receiver_name)s's %(occasion_name)s and you've been invited to help purchase it.") % locals|n}</div>
		%else:
			<div id="page_slogan" class="underlined2">
				${_("POOL_PAGE_SLOGAN_Hi <span class=\"emphasis\">%(user_name)s!</span><br/>%(admin_name)s has created a gift pool for %(receiver_name)s's %(occasion_name)s gift.") % locals|n}
			</div>
			<div class="pageSubSlogan">${_("POOL_PAGE_SLOGAN_Chip in any amount and help make %(receiver_name)s's day special.") % locals|n}</div>
		%endif
	%endif
</%def>


<%def name="admin_slogan(locals)">
	<div id="pool_admin_slogan"><div class="slogan">${description.view(c.pool, False)|n}</div></div>
	<div id="pool_admin_pic"><img src="${c.pool.admin.get_profile_pic()}"/></div>
</%def>

<%def name="render_product(locals)">
	<div class="picture_area product">
		<img class="contentPic" src="${c.pool.product.get_product_pic()}"/>
		<div class="subtext">${c.pool.product.get_display_label(words = 2, seperator = '<br/>')|n}</div>
		%if c.pool.product.tracking_link:
			<a class="submitExtraMini product_more" href="${c.pool.product.tracking_link}" target="_blank">${_("POOL_PAGE_more...")}<span></span></a>
		%endif
	</div>
</%def>

<%def name="render_receiver_picture(locals)">
	<div class="picture_area receiver_picture">
		<img class="contentPic" src="${c.pool.receiver.get_profile_pic('POOL')}"/><div class="subtext">${_("POOL_PAGE_Help make %(receiver_first_name)s's day!") % locals | n}</div>
	</div>
</%def>

<%def name="render_center_buttons(locals)">
	<% daysremaining, hoursremaining = c.pool.get_remaining_days_tuple() %>
	<div id="countdown" class="floaterLeft">
		<div class="countdown_days">${html.counter(daysremaining, _("POOL_PAGE_days and"))}</div>
		<div class="countdown_hours">${html.counter(hoursremaining, _("POOL_PAGE_hours left"))}</div>
	</div>
	<div style="clear:both;padding:10px 0 14px;text-align:center">${_("POOL_PAGE_This gift pool closes on %(end_date)s.") % locals|n}</div>
	
	
	%if c.pool.is_contributable():
			<a href="${url('chipin', pool_url=c.pool.p_url, protocol=app_globals.SSL_PROTOCOL)}" class="buttonRed buttonChipIn ${session.get('lang', '').lower()}"><span>${_("POOL_BUTTON_Chip in!")}</span></a>
			<img src="/static/imgs/icons_paymethod.png"/>
	%elif c.pool.am_i_admin(c.user) and c.pool.is_funded():
		<a href="${url(controller='pool', pool_url=c.pool.p_url, action='settings')}" class="buttonRed buttonChipIn extrawide">
			<span>${_("POOL_BUTTON_ACTION_Order Gift")}</span>
		</a>
	%elif c.pool.am_i_admin(c.user) and c.pool.is_expired():
		<a href="${url(controller='pool', pool_url=c.pool.p_url, action='settings')}" class="buttonRed buttonChipIn superextrawide">
			<span>${_("POOL_PAGE_Visit Pool Admin")}</span>
		</a>
	%else:
		<a class="buttonRed buttonChipIn inactive ${session.get('lang', '').lower()}"><span>${_("POOL_BUTTON_Chip in!")}</span></a>
	%endif
</%def>

<%def name="tooltip_text(locals)">
	<div class="tooltip${c.pool.get_total_contribution()==0 and ' withMessage' or ''}" style="left:${850*c.pool.funding_progress() - 60*c.pool.funding_progress() - 10}px;">
		${locals.get("amount_contributed")|n}
		%if c.pool.get_total_contribution() == 0:
			${_("POOL_PAGE_TOOLTIP_- Be the first among your friends to chip in!")|n}
		%endif
	<span class="bottomYellowTriangle" style="left:${60*c.pool.funding_progress()}px;"></span></div>
</%def>

<%def name="pool_pool_panel(locals)">
	<div id="pool_pool_panel" class="innerbody">
		<div class="pool_content">
			<div class="picture_area_outer product">
				${self.render_product(locals)}
				<span class="icon"></span>
			</div>
			<div class="picture_area_outer receiver_picture">
				${self.render_receiver_picture(locals)}
				<span class="icon"></span>
			</div>
			<div class="floaterLeft" style="text-align:center;width:412px;">
				${self.render_center_buttons(locals)}
			</div>
		</div>
		<div id="timeline_bar">
			<div class="timeline">
				
				<div class="floaterRight limit">
					${h.format_currency(c.pool.product.get_price_float(), c.pool.product.currency)|n}
				</div>
				<div class="floaterLeft limit">${h.format_currency(0, c.pool.currency)|n}</div>
				
				<div class="timeline_progressbar_bg"><div style="width:${c.pool.funding_progress()*850}px;" class="timeline_progressbar"></div>
					${self.tooltip_text(locals)|n}
				</div>
				
				<div class="timelinelegende floaterRight"><a href="#" _href="${url(controller='content', action='pool_too_little_money')}" class="somelink popuplink">${_("POOL_PAGE_What happens if we raise less money?")}</a></div>
				<div class="timelinelegende floaterLeft">${(_("POOL_PAGE_<b>%(amount_contributed)s</b> has been contributed sofar. Only <b>%(amount_left)s to go</b> before %(end_date)s!") % locals)|n}</div>
			</div>
		</div>
	</div>
</%def>

<%def name="social_tools(locals)">
	<div class="social_tools_free underlined1">
		<div class="addthis_toolbox addthis_default_style floaterLeft partialSocial left">
		<a href="http://www.addthis.com/bookmark.php?v=250&amp;username=friendfund" class="somelink addthis_button_compact" style="color:#333">${_("Share this Pool")}</a>
		<span class="addthis_separator">|</span>
		<a class="addthis_button_facebook"></a>
		<a class="addthis_button_twitter"></a>
		<a class="addthis_button_email"></a>
		<a class="addthis_button_buzz"></a>
		<a class="addthis_button_digg"></a>
		<a class="addthis_button_stumbleupon"></a>
		<a class="addthis_button_tumblr"></a>
		</div>
		<div class="floaterLeft partialSocial middle">${_("POOL_Permanent Link:")}<input type="text" onFocus="this.select();" value="${url.current(protocol='http')}"/></div>
		<div class="floaterRight partialSocial right">
		%if c.pool.is_contributable() and c.pool.am_i_member(c.user):
			<a class="loginlink somelink" href="${url('invite_index', controller='invite', pool_url=c.pool.p_url)}">${_("POOL_BUTTON_Invite more Friends to this pool")} <img src="/static/imgs/icon_fb_connect.png"/><img src="/static/imgs/icon_tw_connect.png"/><img src="/static/imgs/icon_mail.png"/></a>
		%endif
		</div>
	</div>
	<div style="clear:both"></div>
</%def>

<%def name="contributors(locals)">
	<% contributors_text = ungettext("POOL_PAGE_%(number_contributors)d person has chipped in for %(receiver_name)s's gift.",
									 "POOL_PAGE_%(number_contributors)d people have chipped in for %(receiver_name)s's gift.", locals['number_contributors']) %>

	<h4 class="inside" style="padding:0px 30px;">${_("POOL_PAGE_Contributors")}</h4>
	<div class="vertNoPadding">${contributors_text % locals}</div>

	<div id="pool_contributors" class="pcont_body">
		<% invitees = [c.pool.admin] + c.pool.invitees %>
		%for i, invitee in enumerate(invitees):
			%if invitee.anonymous:
				${self.render_contributor_secret(i, invitee)}
			%else:
				${self.render_contributor(i, invitee, i==0)}
			%endif
		%endfor
	</div>
</%def>

<%def name="fundchat(locals)">
	<div id="lowerbody_container" class="newFormControls" style="margin: 10px 30px 30px;width:920px;">
		<a name="comments"></a>
		<h4 class="inside" style="padding:0;">${_("POOL_CHAT_Fund Chat")}</h4>
		%if c.pool.am_i_member(c.user):
			<div>${_("POOL_CHAT_Leave your Comment:")}</div>
			<div class="textarea"><textarea id="addcommenttext" _href="${url(controller='pool', pool_url=c.pool.p_url, action='chat')}" name="comment" class="comment_text_input"></textarea></div>
			<div class="floaterLeft"><a class="BtnRed" href="#comments" onclick="submit_fundchat('addcommenttext')"><span>${_("POOL_PAGE_BUTTON_Post!")}</span></a></div>
			<div style="clear:both"></div>
		%endif
		%if c.pool.can_i_view(c.user):
			<div id="fundchat" class="pagelet" pagelet_href="${url(controller='pool', pool_url=c.pool.p_url, action='chat')}">
				${html.loading_animation()|n}
			</div>
		%else:
			${_("POOL_CHAT_This is a secret pool, no chat is shown.")}
		%endif
	</div>
</%def>

<%def name="render_contributor(position, invitee, is_admin = False)">
	<div class="contributor">
		<img src="${invitee.get_profile_pic('PROFILE_M')}" alt="${invitee.name}" class="contributor"/>
		<div class="contributor_name">${invitee.name} ${is_admin and _("POOL_PAGE_(Admin)") or ""}</div>
		%if invitee.contributed_amount:
			<div class="contributor_amount">${_("POOL_PAGE_Has chipped in %(amount)s") % dict([("amount", invitee.get_contribution_amount_text(c.pool.currency))])|n}</div>
			<span class="contributor_contributed"></span>
		%endif
	</div>
</%def>

<%def name="render_contributor_secret(position, invitee, is_admin = False)">
	<div class="contributor">
		<img src="/static/imgs/defaultcontrib_${invitee.sex}_PROFILE_M.png" class="contributor"/>
		%if c.user.is_anon:
			<div class="contributor_name">${_("POOL_CHAT_Someone you might know")}</div>
		%else:
			<div class="contributor_name">${_("POOL_CHAT_Anonymous")}</div>
		%endif
		<div class="contributor_amount">${invitee.get_contribution_amount_text(c.pool.currency)|n}</div>
	</div>
</%def>