<%inherit file="../layout.html"/>
<%namespace name="widgets" file="../widgets/widgets.html"/>
<%def name="scripts()">
	<script type="text/javascript">
		var textCounter = function(field, countfield, maxlimit) {if(field.value.length > maxlimit){field.value=field.value.substring(0, maxlimit);}else{countfield.value=maxlimit-field.value.length;}};
		
		var thous_sep="${h.get_thous_sep()}";var dec_sep="${h.get_dec_sep()}"
		var calcTotals = function(evt){
			var contrib = dojo.byId("payment_amount");
			var contrib_amount = Math.round(parseFloat(contrib.value.replace(thous_sep,"").replace(dec_sep, "."))*100);
			if(isNaN(contrib_amount)){
				dojo.byId("display_amount").value="-";
				dojo.byId("display_transactioncosts").value="-";
				dojo.byId("display_total").value="-";
				dojo.byId("payment_total").value=0;
				
			} else {
				dojo.forEach(document.contributionForm["payment.method"], function(rdio){
					if(rdio.checked){
						var absolute = parseInt(dojo.attr(rdio, "_fee_absolute"));
						var relative = parseFloat(dojo.attr(rdio, "_fee_relative"));
						var costs_amount = (contrib_amount * relative/100) + absolute;
						var amount = dojo.byId("display_amount");
						var tcosts = dojo.byId("display_transactioncosts");
						var total = dojo.byId("display_total");
						amount.value = (contrib_amount/100).toFixed(2).replace(".", dec_sep);
						tcosts.value=(costs_amount/100).toFixed(2).replace(".", dec_sep);
						total.value=((contrib_amount + costs_amount)/100).toFixed(2).replace(".", dec_sep);
						dojo.byId("payment_total").value=total.value;
					}
				});}
		};
		var submitters = [];
		checkLoginStatus = function(evt){
			%if c.user.is_anon:
				xhrPost("${url(controller="myprofile", action="loginpopup")}", {});
				evt.stopPropagation();
				evt.preventDefault();
				return false;
			%else:
				onSubmitCleaner(document.contributionForm);
				document.contributionForm.submit();
			%endif
		};
		submitters.push(dojo.connect(dojo.byId("submitter"), "onclick", checkLoginStatus));
	</script>
</%def>

<%def name="onloadscripts()">
	page_reloader = function(){document.contributionForm.submit()};
	parseDefaultsInputs("contributionForm");
	parseSelectables("contributionForm");
	dojo.query("input[type=radio].paymentselector").onchange(dojo.hitch(null, calcTotals));
	dojo.query("#payment_amount").onkeyup(dojo.hitch(null, calcTotals));
	calcTotals();
</%def>

<div class="wrapSubHeader">${self.renderMessages(c.pool.p_url)|n}

  <div class="subHeader">
    <div class="userProfile">
    
        <div class="prodImgWrap">
          <div class="prodImgSubWrap"> <img src="${c.pool.get_product_display_picture("FF_POOL_PIC_S")}" height="50px" width="60px"> </div>
        </div>
        <div class="subUserProfile">
        <h2>${_("FF_CONTRIB_PAGE_HEADER_Chip In for %s")%c.pool.title|n}</h2>
      </div>
      <div class="steps">
        <div class="stepOne active"><span>1</span>${_("FF_CONTRIB_PAGE_HEADER_Chip in")}</div>
        <div class="rightArrow active"></div>
        <div class="leftArrow"></div>
        <div class="stepTwo "><span>2</span>${_("FF_CONTRIB_PAGE_HEADER_Payment info")}</div>
        <div class="rightArrow "></div>
        <div class="leftArrow "></div>
        <div class="stepThree"><span>3</span>${_("FF_CONTRIB_PAGE_HEADER_Done!")}</div>
      </div>
      <div class="clear"></div>
    </div>
  </div>
</div>

<div class="wrapSubContent">
<div class="content">
	<div class="colRight"></div>
	<div class="colLeft">
	<form action="${url(controller="payment", action="details", pool_url=c.pool.p_url, protocol=app_globals.SSL_PROTOCOL)}" id="contributionForm" name="contributionForm" onSubmit="onSubmitCleaner(this)" method="POST">

		<h4>${_("FF_CONTRIB_PAGE_How much do you want to contribute?")}</h4>
		<div class="subHeading"></div>
		<div class="borderBottom noBorder special ${('amount' in c.errors) and "error" or ""}">

		%if ('amount' in c.errors):
			<div class="tip">
				<div class="arrow"></div>
				<span>${c.errors['amount']}</span> 
			</div>
		%endif
	  
	  
		<div class="first" style="margin-top:15px">${_("FF_CONTRIB_PAGE_Your contribution")}</div>
		<div style="width: 516px;" class="greyInside">
		  
		  <span class="value">${h.display_currency(c.pool.currency)}</span> 
		  <input type="text" value="${c.values.get('amount')}" name="payment.amount" id="payment_amount" style="float:left; width:100px" />
		<p class="alignInput">${_("FF_CONTRIB_PAGE_MAX. CONTRIBUTION:")} <span class="bold"> ${h.format_currency(c.pool.get_amount_left(), c.pool.currency)}</span></p>
		<div id="verisign_contrib" class="floatRight">
			<table width="135" border="0" cellpadding="2" cellspacing="0" title="Click to Verify - This site chose VeriSign SSL for secure e-commerce and confidential communications.">
			<tr>
			<td width="135" align="center" valign="top">
				<script type="text/javascript" src="https://seal.verisign.com/getseal?host_name=www.friendfund.com&amp;size=S&amp;use_flash=NO&amp;use_transparent=NO&amp;lang=en"></script><br />
				<a href="http://www.verisign.com/ssl-certificate/" target="_blank"  style="color:#000000; text-decoration:none; font:bold 7px verdana,sans-serif; letter-spacing:.5px; text-align:center; margin:0px; padding:0px;">ABOUT SSL CERTIFICATES</a>
			</td>
			</tr>
			</table></div>
		</div>
		</div>
		<% locals = {"expiry_date":h.format_date(c.pool.expiry_date, format="full"),"admin_name":c.pool.admin.name} %>
		<div class="contentDetails">
			<div class="imgSpacer"> 
				 %for i, pm in enumerate(c.payment_methods):
					<img src="/static/imgs/${pm.code}.png"/>
				%endfor
			</div>
		${_("FF_CONTRIB_PAGE_You won&#39;t be charged anything unless this Pool is fully funded by %(expiry_date)s. If it isn't funded in time, no one pays a single penny.")%locals}
		<a href="#">${_("FF_CONTRIB_PAGE_Learn More")} Â»</a>
		</div>
      
		<div class="clear"></div>
		<h4>${_("FF_CONTRIB_PAGE_Add a personal message <span>(optional)</span>")|n}</h4>
		<div class="subHeading"></div>
		<div class="borderBottom noBtmPad noBorder">
			<div class="tip">
				<div class="arrow"></div>
				<span>${_("FF_CONTRIB_PAGE_This message will appear on (%(admin_name)s's) e-card if the Pool is successfully funded.")%locals}</span>
			</div>
			<div class="greyInsideFullWidth">        
				<div class="first"> <span>${_("FF_CONTRIB_PAGE_Your message")}</span> </div>
				<div class="containerTxtArea">
					<textarea class="default" _default_text="${_("FF_CONTRIB_PAGE_Write your description here...")}" wrap="soft"
									onKeyDown="textCounter(this,this.form.remLen,140);" 
									onKeyUp="textCounter(this,this.form.remLen,140);" 
									name="payment.message" id="chipin_message">${c.values.get("message", _("FF_CONTRIB_PAGE_Write your description here..."))}</textarea>
				</div>
			</div>
			<div class="floatRight">
				<input class="number bold" disabled="disabled" readonly="readonly" type="text" 
					id="chipin_message_remLen" name="remLen" size="3" maxlength="3" value="${140-len(c.values.get("message", c.pool.get_my_message(c.user)) or '')}"/>
			</div>
			<p class="info"></p>
		</div>

	<div class="clear"></div>
	<h4>${_("FF_CONTRIB_PAGE_Payment Method")}</h4>
	<div class="subHeading" style="margin-bottom:10px"></div>
	<div style="position:relative" class="lessPad">
	%for i, pm in enumerate(c.payment_methods):
			<div class="greyInsideFullWidth">        
				<div class="first"> <span>&nbsp</span> </div>
				<input type="radio" class="paymentselector radio" value="${pm.code}" _fee_absolute="${pm.fee_absolute}" _fee_relative="${pm.fee_relative}" 
					name="payment.method" id="payment_method_${pm.code}" ${widgets.input_checked("method", pm.code, i==0)|n} /> 
				<label for="payment_method_${pm.code}" class="fourteen"> ${_(pm.code)} <span class="greySmallSpan">${h.format_currency(float(pm.fee_absolute)/100, c.pool.currency)} + ${pm.fee_relative/100}% fee</span> </label>
			</div>
	%endfor
		<div class="smallTable">
			<div class="floatLeft">${_("FF_CONTRIB_PAGE_Amount")}</div><input class="floatRight" type="text" disabled="disabled" id="display_amount" value="0"/><div class="clear" style="padding-top:5px"></div>
				<div class="floatLeft"><span id="payment_method_name"></span>${_("FF_CONTRIB_PAGE_Payment Fees")}</div><input class="floatRight" type="text" disabled="disabled" id="display_transactioncosts" value="0"/>
				<div class="clear"  style="padding-top:5px; border-bottom: 2px solid #dad9d8;"></div>
			   <div class="divider">
					<div class="floatLeft bold effect">${_("FF_CONTRIB_PAGE_Total")}</div><input class="floatRight boldeffect" type="text" disabled="disabled" id="display_total" value="0"/>
					<div class="clear"></div>
				<input type="hidden" id="payment_total" name="payment.total" /> 
			   </div>
			<span class="link">What are these payment fees?</span>
		</div>
	</div>

	<div class="recMoney">
		<h4>${_("FF_CONTRIB_PAGE_Privacy Settings")}</h4>
		<div class="subHeading" style="margin-bottom:10px"></div>

		<div class="borderBottom noBorder lessPad">
			<div class="tip">
				<div class="arrow"></div>
				<span>${_("FF_CONTRIB_PAGE_PRVACY_SETTING_Tip goes here")}</span>
			</div>
			<div class="greyInsideFullWidth">
				<div class="first"> <span>&nbsp</span> </div>
				<input type="radio" id="isSecretFalse" name="payment.is_secret" value="no" ${widgets.input_checked("is_secret", "no", default=True)|n} class="radio"><label  for="isSecretFalse">
				${_("FF_CONTRIB_PAGE_I'm happy to show how much I've chipped in")}</label>
			</div>
		</div>

      <div class="borderBottom noBorder lessPad">
        <div class="tip">
            <div class="arrow"></div>
          <span>Tip goes here</span> </div>
        <div class="greyInsideFullWidth">
          <div class="first"> <span>&nbsp</span> </div>
          <input type="radio" id="isSecretTrue" name="payment.is_secret" value="yes" ${widgets.input_checked("is_secret", "yes")|n} class="radio"><label for="isSecretTrue">
			${_("FF_CONTRIB_PAGE_I don't want anyone to see how much I've chipped in")}</label>
        </div>
      </div>
	<div class="spacerBorder"></div>
	<div class="borderBottom txtInside noBorder lessPad ${('agreedToS' in c.errors) and "error" or ""}">
		<div class="tip">
			<div class="arrow"></div>
		%if ('agreedToS' in c.errors):
			<span>${c.errors['agreedToS']}</span> 
		%else:
			<span>${_("FF_CONTRIB_PAGE_TERMSOFSERVICE_Tip goes here")}</span> 
		%endif
		</div>
        <div class="disclaimer">${_("STATIC_TERMS_OF_SERVICE_CONTENT")|n}</div>
		<div class="greyInsideFullWidth">
			<div class="first"> <span>&nbsp</span> </div>
			<input type="checkbox" id="chipin_agreedToS" name="payment.agreedToS" value="yes" ${widgets.input_checked("agreedToS", True)|n} class="chkbox">
			<label for="chipin_agreedToS">${_("FF_CONTRIB_PAGE_I accept the")}</label><a tabIndex="5000" href="${url(controller="content", action="tos")}">${_("FF_CONTRIB_PAGE_Terms of service")}</a>
		</div>
	</div>
	
    <div class="floatRight">
			<div class="spacerButtons">
				<span id="submitter" class="forward floatLeft"><span>${_("FF_CONTRIB_PAGE_BUTTON_Chip In")}</span> <input type="button" value="&gt;"></span>
			</div>
		</div>
      
	<div class="clear"></div>
	</div>
	</form>
  </div>
  <div class="clear"></div>
</div>
</div>