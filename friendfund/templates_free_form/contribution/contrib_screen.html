<%inherit file="../layout.html"/>
<%namespace name="widgets" file="../widgets/widgets.html"/>
<%def name="scripts()">
	<script type="text/javascript">
		var textCounter = function(field, countfield, maxlimit) {if(field.value.length > maxlimit){field.value=field.value.substring(0, maxlimit);}else{countfield.value=maxlimit-field.value.length;}};
		
		var thous_sep="${h.get_thous_sep()}";var dec_sep="${h.get_dec_sep()}"
		var calcTotals = function(evt){
			var contrib = dojo.byId("payment_amount");
			var contrib_amount = Math.round(parseFloat(contrib.value.replace(thous_sep,"").replace(dec_sep, "."))*100);
			dojo.forEach(document.contributionForm["payment.method"], function(rdio){
				if(rdio.checked){
					var absolute = parseInt(dojo.attr(rdio, "_fee_absolute"));
					var relative = parseFloat(dojo.attr(rdio, "_fee_relative"));
					var costs_amount = (contrib_amount * relative/100) + absolute;
					var amount = dojo.byId("display_amount");
					var tcosts = dojo.byId("display_transactioncosts");
					var total = dojo.byId("display_total");
					amount.value = (contrib_amount/100).toFixed(2).replace(".", dec_sep);
					tcosts.value=(costs_amount/100).toFixed(2).replace(".", dec_sep);
					total.value=((contrib_amount + costs_amount)/100).toFixed(2).replace(".", dec_sep);
					dojo.byId("payment_total").value=total.value;
				}
			});
		};
	</script>
</%def>

<%def name="onloadscripts()">
	parseDefaultsInputs("contributionForm");
	parseSelectables("contributionForm");
	dojo.query("input[type=radio].paymentselector").onchange(dojo.hitch(null, calcTotals));
	dojo.query("#payment_amount").onkeyup(dojo.hitch(null, calcTotals));
	calcTotals();
</%def>

<div class="wrapSubHeader">${self.renderMessages()|n}
  <div class="subHeader">
    <div class="userProfile">
      <div class="nonPoolHeader">
        <div class="prodImgWrap">
          <div class="prodImgSubWrap"> <img src="${c.pool.get_product_display_picture("FF_POOL_PIC_S")}" height="50px" width="60px"> </div>
        </div>
        <h2>${c.pool.title}</h2>
      </div>
      <div class="steps">
        <div class="stepOne active"><span>1</span>Chip in</div>
        <div class="rightArrow active"></div>
        <div class="leftArrow"></div>
        <div class="stepTwo "><span>2</span>Payment info</div>
        <div class="rightArrow "></div>
        <div class="leftArrow "></div>
        <div class="stepThree"><span>3</span>Done !</div>
      </div>
      <div class="clear"></div>
    </div>
  </div>
</div>


<div class="content">
  <div class="colRight"></div>
  <div class="colLeft">
  <form action="${url(controller="payment", action="details", pool_url=c.pool.p_url, protocol=app_globals.SSL_PROTOCOL)}" id="contributionForm" name="contributionForm" onSubmit="onSubmitCleaner(this)" method="POST">
    <div class="poolDets">
      <h4>How much do you want to contribute?</h4>
      <div class="borderBottom noBorder special ${('amount' in c.errors) and "error" or ""}">
	  
		%if ('amount' in c.errors):
			<div class="tip">
				<div class="arrow"></div>
				<span>${c.errors['amount']}</span> 
			</div>
		%endif
	  
	  
        <div class="first" style="margin-top:8px">Your contribution</div>
        <div class="greyInside widthAuto borderGrey">
          <input type="text" value="${c.values.get('amount')}" name="payment.amount" id="payment_amount" />
          <span class="value">${h.display_currency(c.pool.currency)}</span> </div>
        <p class="alignInput">MAX. CONTRIBUTION: <span class="bold"> ${h.format_currency(c.pool.get_amount_left(), c.pool.currency)}</span></p>
		<div id="verisign_contrib" class="floatRight">
			<table width="135" border="0" cellpadding="2" cellspacing="0" title="Click to Verify - This site chose VeriSign SSL for secure e-commerce and confidential communications.">
			<tr>
			<td width="135" align="center" valign="top">
				<script type="text/javascript" src="https://seal.verisign.com/getseal?host_name=www.friendfund.com&amp;size=S&amp;use_flash=NO&amp;use_transparent=NO&amp;lang=en"></script><br />
				<a href="http://www.verisign.com/ssl-certificate/" target="_blank"  style="color:#000000; text-decoration:none; font:bold 7px verdana,sans-serif; letter-spacing:.5px; text-align:center; margin:0px; padding:0px;">ABOUT SSL CERTIFICATES</a>
			</td>
			</tr>
			</table></div>
		</div>
		<div class="contentDetails">
			<h6>When will I be charged?</h6>
				You won&#39;t be charged anything unless this Pool is fully funded by ${h.format_date(c.pool.expiry_date, format="full")}. If it isn't 
				funded in time, no one pays a single penny.<a href="#"> Learn More Â»</a>
			<h6>Accepted Payment Methods</h6>
			<div class="imgSpacer"> 
				 %for i, pm in enumerate(c.payment_methods):
					<img src="/static/imgs/${pm.code}.png"/>
				%endfor
			</div>
		</div>
      
	  <div class="clear"></div>
      <h4>Add a personal message <span>(optional)</span></h4>
      <div class="borderBottom"  style="border:none">
      <div class="tip">
					<div class="arrow"></div>
						<span>Tip goes here Tip goes here Tip goes here Tip goes here Tip goes here Tip goes here</span>
				</div>
        <div class="greyInsideFullWidth">        
        <div class="first"> <span>Your message</span> </div>
        <div class="containerTxtArea">
          <textarea class="default" _default_text="Write your description here..." wrap="soft"
							onKeyDown="textCounter(this,this.form.remLen,140);" 
							onKeyUp="textCounter(this,this.form.remLen,140);" 
							name="payment.message" id="chipin_message">${c.values.get("message", "Write your description here...")}</textarea>
        </div>
        </div>
        <div class="floatRight"><input class="number bold" disabled="disabled" readonly="readonly" type="text" id="chipin_message_remLen" name="remLen" size="3" maxlength="3" value="${140-len(c.values.get("message", c.pool.get_my_message(c.user)) or '')}"> </div>
        <p class="info">This message will appear on (Admin name's) e-card if the Pool is successfully funded.</p>
      </div>
      <div class="clear"></div>
    </div>

	<div class="clear"></div>
	<h4>Payment Method</h4>
	<div class="borderBottom" style="border:none">
		<div class="tip">
			<div class="arrow"></div>
				<span>Tip goes here Tip goes here Tip goes here Tip goes here Tip goes here Tip goes here</span>
			</div>
			
		
		<div class="greyInsideFullWidth">        
			%for i, pm in enumerate(c.payment_methods):
				<input type="radio" class="paymentselector" value="${pm.code}" _fee_absolute="${pm.fee_absolute}" _fee_relative="${pm.fee_relative}" name="payment.method" id="payment_method_${pm.code}" ${widgets.input_checked("method", pm.code, i==0)|n}/>
				<div class="first"> <span><label for="payment_method_${pm.code}"><img class="floatLeft" src="/static/imgs/${pm.code}.png"/>${_(pm.code)}</label></span> </div>
			%endfor
		</div>
		<div style="margin:30px;">
			<div class="floatLeft">Amount</div><input class="floatLeft" type="text" disabled="disabled" id="display_amount" value="0"/><div class="clear"></div>
			<div class="floatLeft"><span id="payment_method_name"></span> Charges</div><input class="floatLeft" type="text" disabled="disabled" id="display_transactioncosts" value="0"/><div class="clear"></div>
			<div class="floatLeft">Total</div><input class="floatLeft" type="text" disabled="disabled" id="display_total" value="0"/><div class="clear"></div>
			<input type="hidden" id="payment_total" name="payment.total" /> 
		</div>
		<div class="clear"></div>
	</div>

	<div class="recMoney">
		<h4 style="margin-bottom:10px">Privacy Settings</h4>

		<div class="borderBottom noBorder lessPad">
			<div class="tip">
				<div class="arrow"></div>
				<span>Tip goes here</span>
			</div>
			<div class="greyInsideFullWidth">
				<div class="first"> <span>&nbsp</span> </div>
				<input type="radio" id="isSecretFalse" name="payment.is_secret" value="no" ${widgets.input_checked("is_secret", "no", default=True)|n} class="radio"><label  for="isSecretFalse">I'm happy to show how much I've chipped in</label>
			</div>
		</div>

      <div class="borderBottom noBorder lessPad">
        <div class="tip">
            <div class="arrow"></div>
          <span>Tip goes here</span> </div>
        <div class="greyInsideFullWidth">
          <div class="first"> <span>&nbsp</span> </div>
          <input type="radio" id="isSecretTrue" name="payment.is_secret" value="yes" ${widgets.input_checked("is_secret", "yes")|n} class="radio"><label for="isSecretTrue">I don't want anyone to see how much I've chipped in</label>
        </div>
      </div>
	<div class="spacerBorder"></div>
	<div class="borderBottom noBorder lessPad ${('agreedToS' in c.errors) and "error" or ""}">
		<div class="tip">
			<div class="arrow"></div>
		%if ('agreedToS' in c.errors):
			<span>${c.errors['agreedToS']}</span> 
		%else:
			<span>Tip goes here</span> 
		%endif
		</div>
		<div class="greyInsideFullWidth">
			<div class="first"> <span>&nbsp</span> </div>
			<input type="checkbox" id="chipin_agreedToS" name="payment.agreedToS" value="yes" ${widgets.input_checked("agreedToS", True)|n} class="chkbox">
			<label for="chipin_agreedToS">I accept the </label><a href="${url(controller="content", action="tos")}">Terms of service</a>
		</div>
	</div>
	<div class="terms">
		<input type="submit" value="Chip In" class="primaryButton" id="submitter"/>
	</div>
      
	<div class="clear"></div>
	</div>
	</form>
  </div>
  <div class="clear"></div>
</div>
