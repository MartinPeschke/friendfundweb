<%! from operator import add %>
<%inherit file="../layout.html"/>
<%namespace name="links" file="../widgets/links.html"/>
<%namespace name="inviter" file="inviter.html"/>
<%namespace name="widgets" file="../widgets/widgets.html"/>

<%def name="scripts()">
	${links.js('friendfund/FriendSelector.js')}
	${links.js('friendfund/InvitePage.js')}
</%def>
<%def name="onloadscripts()">
	parseDefaultsInputs("inviteMessage");
	page = new friendfund.InvitePage({
			container : "inviteContainer",
			invited_node :"invitedContainer",
			method : "${c.method}",
			fb_api_key : "",
			base_url : "${url('invite_index', controller='invite', pool_url=c.pool.p_url)}",
			target_form : "invitees"
		});
	page_reloader = dojo.hitch(null, page.prepareSubmit, page);
	parseSelectables("invitees", "wrapInside");
	dojo.query(".popuplink", "inviteMessage").onclick(dojo.hitch(null, loadPopup));
</%def>

<div class="wrapSubHeader">
  <div class="subHeader">
    <div class="userProfile">
	%if c.workflow in ["2", "3"]:
		<div class="nonPoolHeader">
			<div class="prodImgWrap">
			  <div class="prodImgSubWrap"> <img src="${c.pool.get_product_display_picture("FF_POOL_PIC_S")}" height="50px" width="60px;"> </div>
			</div>
			<h2>${_("FF_INVITEPAGE_HEADER_Invite friends to chip in")}</h2>
		</div>
		%if c.workflow=="2":
			${widgets.renderSteps(_("FF_INVITEPAGE_HEADER_Pool Details"), _("FF_INVITEPAGE_HEADER_Invite friends to chip in"), _("FF_INVITEPAGE_HEADER_Done!"), 2)|n}
		%endif
	%else:
		<div class="nonPoolHeader">
			<div class="prodImgWrap">
			  <div class="prodImgSubWrap"> <img src="${c.pool.get_product_display_picture("FF_POOL_PIC_S")}" height="50px" width="60px;"> </div>
			</div>
			<h2>${_("FF_INVITEPAGE_HEADER_Step 3. Invite Your Friends To Chip In")}</h2>
		</div>
		${widgets.renderSteps(_("FF_INVITEPAGE_HEADER_What are you collecting money for?"), _("FF_INVITEPAGE_HEADER_Enter pool details"), _("FF_INVITEPAGE_HEADER_Invite friends to chip in"), 3)|n}
	%endif
      <div class="clear"></div>
    </div>
  </div>
</div>
<div class="wrapSubContent">
<div class="content">
  <div class="colRight moreMarginTop">
  	<span class="floatRight link" id="removeall">${_("FF_INVITEPAGE_Remove All")}</span>
    <h3>${_("FF_INVITEPAGE_HEADER_Invited Friends")} (<span id="invitedCounter">${reduce(add, map(len, c.invitees.values()) or [0])}</span>)</h3>
		<div class="listSelectedFriends" id="invitedContainer" >
			<p class="inviterTwo ${bool(c.invitees) and "hidden" or ""}">${_("FF_INVITER_EMAIL_Invite your friends from<br /> the left panel")|n}</p>
			<div id="network_invitees" class="invited_list">
				${inviter.render_email_friends(c.invitees.get("email", dict()))}
				${inviter.render_network_friends(c.invitees.get("twitter", dict()))|n}
				${inviter.render_network_friends(c.invitees.get("facebook", dict()))|n}
			</div>
		</div>
  </div>
	<div class="colLeft">
		<div class="invited" id="inviteContainer">
		  <h4>${_("FF_INVITEPAGE_HEADER_Invite your friends from Facebook, Twitter or Email")} <span class="link floatRight">${_("FF_INVITEPAGE_how will my friends be notified?")}</span></h4>
		  <div class="subHeading"></div>
		 
		  <div class="wrapTabs">
			<div class="tabs"> 
                <span class=" methodselector ajaxlink ${c.method == 'facebook' and 'selected' or ''}" _type="facebook">Facebook</span> 
				<span class=" methodselector ajaxlink ${c.method == 'twitter' and 'selected' or ''}" _type="twitter">Twitter</span> 
				<span class=" methodselector ajaxlink ${c.method == 'email' and 'selected' or ''}" _type="email">Email</span> 
			</div>
		  </div>
		  
		  <div class="subTab" id="inviter"></div>

		  <h4>${_("FF_INVITEPAGE_Add a Personal Message to your Invitees <span>(optional)</span>")|n}</h4>
		  <div class="subHeading"></div>
		  <form action="${url(controller='invite', pool_url=c.pool.p_url, action='friends')}" onsubmit="return prepareSubmit()" method="POST" id="invitees">
			<input type="hidden" name="v" value="${c.workflow}"/>
		  <div style="border-top:none" class="borderBottom" id="inviteMessage">
			<div class="wrapInside ${('subject' in c.errors) and "error" or ""}">
				<div class="tip">
						<div class="arrow"></div>
					%if 'subject' in c.errors:
						<span>${c.errors['subject']}</span>
					%else:
						<span>${_("FF_INVITEPAGE_SUBJECT_Tip goes here")}</span>
					%endif
				</div>
				<div class="first"> <span>${_("FF_INVITEPAGE_Subject")}</span> </div>
				<div class="containerTxtArea">
				  <input type="text" class="default" name="subject" _default_text="${_("FF_INVITEPAGE_Write your subject here...")}" value="${c.values.get("subject", _("FF_INVITEPAGE_Write your subject here..."))}"/>
				</div>
			</div>
			<div class="padSpacer"></div>
			<div class="wrapInside ${('message' in c.errors) and "error" or ""}">
				<div class="tip">
						<div class="arrow"></div>
					%if 'message' in c.errors:
						<span>${c.errors['message']}</span>
					%else:
						<span>${_("FF_INVITEPAGE_MESSAGE_Tip goes here")}</span>
					%endif
				</div>
				
				<div class="first"> <span>${_("FF_INVITEPAGE_Your message")}</span> </div>
				<div class="containerTxtArea">
				  <textarea name="message" class="default" rows="6" _default_text="${_("FF_INVITEPAGE_Write your message here...")}">${c.values.get("message", _("FF_INVITEPAGE_Write your message here..."))}</textarea>
				</div>
			</div>
			<p class="info"><a class="popuplink" _href="${url(controller="invite", pool_url = c.pool.p_url, action="preview", method="c.method")}">${_("FF_INVITEPAGE_How will my message be displayed?")}</a></p>
		  </div>
			<div class="inviteBottom">
			   <div class="spacerPadLeft floatLeft">
					<p>${_("FF_INVITEPAGE_If you are inviting friends manually, here's a link to your pool:")}</p>
					<input type="text" class="copy" value="${url("get_pool", pool_url = c.pool.p_url, protocol="http")}" onfocus="this.select();"/>
				</div>
				
				<div class="btnContainer">
				%if len(c.pool.invitees) or c.workflow=="3":
					<input type="button" id="invite_submitter" value="${_("FF_INVITEPAGE_BUTTON_Invite Friends")}" class="primaryButton" />
				%else:
					<input type="button" id="invite_submitter" value="${_("FF_INVITEPAGE_BUTTON_Create Pool")}"  class="primaryButton" />
				%endif
				</div>
			</div>
		</form>
      	</div>
      <div class="clear"></div>
    </div>
    <div class="clear"></div>
  </div>
  <div class="clear"></div>
</div>
</div>