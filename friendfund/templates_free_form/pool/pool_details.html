<%inherit file="../layout.html"/>
<%namespace name="links" file="../widgets/links.html"/>
<%namespace name="widgets" file="../widgets/widgets.html"/>
<%def name="scripts_styles()">
	${links.js('datepicker.packed.js')}
	${links.css('datepicker.css')}
</%def>
<%def name="scripts()">
	<script type="text/javascript"> 
		toggleSettlement = function(option){
			var parent = findParent(option, "hiderParent");
			dojo.query(".hideable:not(.hidden)", "settlementOptions").forEach(function(elem){
				dojo.addClass(elem, "hidden");
			});
			if(parent){dojo.query(".hideable.hidden", parent).forEach(function(elem){dojo.removeClass(elem, "hidden");});}
		};
	</script>
</%def>

<%def name="onloadscripts()">
	page_reloader = function(){document.submissionform.submit()};
	parseDefaultsInputs("poolDetails");
	parseSelectables("poolDetails");
	parseSimpleEditables("poolDetails");
	parseEditables("poolDetails");
	
	var today = new Date();
	var defaultDateOffset = 14;
	var defaultDate = new Date(today.getDate() + defaultDateOffset);
	if(dojo.byId("dateValue").value){
		defaultDate = new Date(dojo.byId("dateValue").value);
		var displaydate = Math.ceil((defaultDate.getTime()-today.getTime())/(24*3600*1000));
		if(isNaN(displaydate))displaydate=0;
		dojo.byId("daysLeft").innerHTML = displaydate;
	}
	var fmtDate = "M-sp-d-cc-sp-Y";
	var machineFmtDate = "Y-ds-m-ds-d";
	datePickerController.createDatePicker({
	  formElements:{"datepicker":fmtDate},
	  dateFormats:{"datepicker":["Y-sl-m-sl-d", "d-dt-m-dt-Y", "Y-ds-m-ds-d"]},
	  rangeLow:today.getFullYear() + "" + lpad(today.getMonth()+1) + lpad(today.getDate()), 
	  rangeHigh:(today.getFullYear()+5) + "" + lpad(today.getMonth()+1) + lpad(today.getDate()), 
	  callbackFunctions:{"dateset":[
			function(params){
				if(params.date){
					dojo.byId("daysLeft").innerHTML = Math.ceil((params.date.getTime()-(today).getTime())/(24*3600*1000));
					dojo.byId("dateValue").value=datePickerController.printFormattedDate(params.date, machineFmtDate, true);
					if(dojo.hasClass("date_error_row", "error")&&dojo.query(".tip", "date_error_row").length===0){dojo.removeClass("date_error_row", "error")}
					
				} else {
					var nDate = new Date(dojo.byId("dateValue").value);
					//dojo.byId("datepicker").value="---"; //datePickerController.printFormattedDate(nDate, fmtDate, true);
					dojo.byId("daysLeft").innerHTML="---"; //Math.ceil((nDate.getTime()-(today).getTime())/(24*3600*1000));
					dojo.byId("dateValue").value="";
					var elem = dojo.byId("date_error_row");
					if(!dojo.hasClass(elem, "error")){dojo.addClass(elem, "error")}
				}
			}
		]}
	});
	%if c.values.get('tracking_link'):
		var hue = document.getElementById("homeurlexpander");
		hue.appendChild(renderController());
		hue.insertBefore(renderPictures(["${'","'.join(c.values['img_list'])|n}"], "${c.values['product_picture']}"), hue.firstChild);
	%else:
		connectURLParser("tracking_link_edit");
	%endif
	#### check settlementOptions
	dojo.forEach(document.submissionform.settlementOption, function(elem){if(elem.checked){toggleSettlement(elem);}});
	
	var submitters = [];
	checkLoginStatus = function(evt){
		%if c.user.is_anon:
			xhrPost("${url(controller="myprofile", action="loginpopup")}", {});
			evt.stopPropagation();
			evt.preventDefault();
			return false;
		%else:
			onSubmitCleaner(document.submissionform);
			document.submissionform.submit();
		%endif
	};
	submitters.push(dojo.connect(dojo.byId("submitter"), "onclick", checkLoginStatus));
</%def>


<div class="wrapSubHeader">
	<div class="subHeader">
		<div class="userProfile">
			%if c.workflow == "2":
				<div class="nonPoolHeader">
					<h2>${_("FF_POOLDETAILS_HEADER_Create a Pool")}</h2>
				</div>
				${widgets.renderSteps(_("FF_POOLDETAILS_HEADER_Pool Details"), _("FF_POOLDETAILS_HEADER_Invite friends to chip in"), _("FF_POOLDETAILS_HEADER_Done!"), 1)|n}
			%else:
				<div class="nonPoolHeader">
					<h2>${_("FF_POOLDETAILS_HEADER_Step 2. Enter Your Pool Details")}</h2>
				</div>
				${widgets.renderSteps(_("FF_POOLDETAILS_HEADER_What are you collecting money for?"), _("FF_POOLDETAILS_HEADER_Enter pool details"), _("FF_POOLDETAILS_HEADER_Invite friends to chip in"), 2)|n}
			%endif
		<div class="clear"></div>
		</div>
	</div>
</div>
<div class="content">
  <div class="colRight"></div>
	<div class="colLeft">
		<form method="POST" id="submissionform" name="submissionform" action="${url("pool_create")}">
		<input type="hidden" name="v" value="${c.workflow}"/>
		<div class="poolDets" id="poolDetails">
			<h4>${_("FF_POOLDETAILS_HEADER_Pool Details")}</h4>
			<div class="subHeadingSpecial"></div>
			<div class="special borderBottom ${h.contains_one(["currency", "amount", "date"], c.errors) and "error" or ""}" id="date_error_row">
				%if h.contains_one(["currency", "amount", "date"], c.errors):
					<div class="tip">
						<div class="arrow"></div>
						<span>
							<ul>
								%if 'currency' in c.errors:
									<li>${c.errors.get("currency")}</li>
								%endif
								%if 'amount' in c.errors:
									<li>${c.errors.get("amount")}</li>
								%endif
								%if 'date' in c.errors:
									<li>${c.errors.get("date")}</li>
								%endif
							</ul>
						</span>
					</div>
				%endif
			
			
				<div class="first" style="margin-top:7px;"><span>${_("FF_POOLDETAILS_We Need")}</span>
					<span class="editable active" _elem="currency" _value="${c.values['currency']}">${h.display_currency(c.values['currency'])}<input type="hidden" name="currency" value="${c.values['currency']}"/></span>
				</div>
				<div class="greyInside" style="width:516px">
					%if "amount" in c.errors or c.workflow != "1":
						<input type="text" value="${c.values['amount']}" name="amount" class="small" />
					%else:
						<div class="editorCtn">
							<span class="simpleeditable active mainValue">${c.values['amount']}
								<input _type="INPUT" type="hidden" value="${c.values['amount']}" name="amount" class="small" id="amountInput" />
								<span style="margin:0 0 0 5px" class="link ">Edit</span>
							</span>
						</div>
					%endif
					
					
					
					<span style="margin-right:5px">${_("FF_POOLDETAILS_by")}</span>
					<input class="small" readonly="readonly" type="text" id="datepicker" value="${h.format_date(c.values.get('date'))}"/>
					<input type="hidden" name="date" id="dateValue" value="${h.format_date_internal(c.values.get('date'))}"/>
					<span class="darkGrey floatRight">${_("FF_POOLDETAILS_<span class=\"bold\" id=\"daysLeft\">0</span> DAYS LEFT")|n}</span>
				</div>
			</div>
			
			
			<div class="borderBottom ${('title' in c.errors) and "error" or ""}">
				<div class="tip">
					<div class="arrow"></div>
					%if 'title' in c.errors:
						<span>${c.errors['title']}</span>
					%else:
						<span>${_("FF_POOLDETAILS_TITLE_Tip goes here")}</span>
					%endif
				</div>
			
				<div class="greyInsideFullWidth">
				<div class="first">
					<span>${_("FF_POOLDETAILS_LABEL_Pool Title")}</span>
				</div>
				
					%if "title" in c.errors or c.workflow != "1":
						<input type="text" name="title" _default_text="${_("FF_POOLDETAILS_Write your title here...")}" class="default" value="${c.values['title'] or _("FF_POOLDETAILS_Write your title here...")}" />
					%else:
						<span class="simpleeditable active mainValue">${c.values['title']}
							<input _type="INPUT" type="hidden" value="${c.values['title']}" name="title" id="titleInput" />
							<span style="margin:0 0 0 5px" class="link ">Edit</span>
						</span>
					%endif
				
				</div>
			</div>
			
			
			<div class="borderBottom ${('description' in c.errors) and "error" or ""}">
				<div class="tip">
					<div class="arrow"></div>
					%if 'description' in c.errors:
						<span>${c.errors['description']}</span>
					%else:
						<span>${_("FF_POOLDETAILS_DESCRIPTION_Tip goes here")}</span>
					%endif
				</div>

            	<div class="greyInsideFullWidth">
				<div class="first">
					<span>${_("FF_POOLDETAILS_LABEL_Pool Description")}</span>
				</div>
				<div class="containerTxtArea">
					<textarea name="description" _default_text="${_("FF_POOLDETAILS_Write your description here...")}" class="default">${c.values['description'] or _("FF_POOLDETAILS_Write your description here...")}</textarea>
				</div>
                </div>
			</div>
			%if c.values.get('tracking_link'):
				<div class="generalPadding">
				<div class="first">
						<span>Pool Image</span>
					</div>
					<div id="homeurlexpander" class="home_expander">
						<div class="title simpleeditable active">${h.word_truncate_by_letters(c.values.get("product_name", ""), 50)}
							<span class="link"> Edit</span>
							<input type="hidden" _type="INPUT" _length="50" class="ptitleSimpleEdit" id="product_name_edit" name="product_name" value="${c.values.get("product_name", "")}"/></div>
						<a class="address smallAddress" href="${c.values['tracking_link']}">${h.word_truncate_by_letters(c.values['tracking_link'], 40)}
							<input type="hidden" name="tracking_link" value="${c.values['tracking_link']}" /></a>
						<div class="desc simpleeditable active">${h.word_truncate_by_letters(c.values.get("product_description", ""), 180)}
							<input type="hidden" _type="TEXTAREA" _length="180" name="product_description" value="${c.values.get("product_description", "")}"/></div>
					</div>
				</div>
			%else:
				<div class="generalPadding">
					<div class="first">
						<span>Pool Image</span>
					</div>
					<div id="homeurlexpander" class="home_expander">
						<div class="imgCntSld"></div>
						<div class="title">
							<input type="text" class="ptitleSimpleEdit default" _default_text="${_("FF_POOLDETAILS_Examples:www.cnn.com")}" 
								id="tracking_link_edit" _url="${url(controller="product", action="open_bounce")}" value="${_("FF_POOLDETAILS_Examples:www.cnn.com")}"/>
						</div>
					</div>
				</div>
			%endif
			<div class="clear"></div>
		</div>
		<h4>${_("FF_POOLDETAILS_Receiving Your Money")}</h4>
		<div class="subHeading"></div>
		<div class="padLeft">
			<div class="receiveMoney" id="settlementOptions">
				<p>${_("FF_POOLDETAILS_How do you want to receive your money once the Pool is funded?")}
					<span>${_("FF_POOLDETAILS_You will only be paid if your Pool is successfully funded. This information will not be shared with anyone else.")}</span>
				</p>
				
				%for i, so in enumerate(request.merchant.settlement_options):
					<div class="hiderParent">
						<input type="radio" name="settlementOption" value="${so.name}" ${widgets.expression_quote(c.values['settlementOption']==so.name or i==0, "checked")|n} id="${so.name}_option" class="chkbox" onclick="toggleSettlement(this);"/>
						<label for="${so.name}_option">
							${_(so.name)} 
							%if so.fee:
								(costs you ${so.fee*100}%)
							%else:
								<span class="free">(FREE)</span>
							%endif 
						</label>
						%if so.fee:
						<div class="verticalTip hideable hidden">
						<div class="arrow"></div>
							<span>
								${_("FF_POOLDETAILS_If choosing this option, you will be charged a %s%% fee. Do you want to add this to your Pool Funding Total?")%(so.fee*100)}
							</span>
							<div style="margin-top:5px"><input type="checkbox" name="${so.name}.charge_through" id="${so.name}_charge_through" value="1"  
										${widgets.expression_quote(c.values.get(so.name, dict()).get("charge_through"), "checked")|n}/>
								<label for="${so.name}_charge_through" class="bold">${_("FF_POOLDETAILS_Yes, please add the %s%% to my Funding Total")%(so.fee*100)}</label>
							</div>
						</div>
						%endif
						%if so.required_fields:
							<div id="${so.name}_form" class="requiredForm hideable hidden">
								%for rf in so.required_fields:
									<div class="smallLabel"><label>${_(so.name)} ${_(rf.name)}</label><input type="text" name="${so.name}.${rf.name}" value="${c.values.get(so.name, dict()).get(rf.name)}" /></div>
									%if rf.name in c.errors.get(so.name, dict()):
										<span>${c.errors[so.name][rf.name]}</span>
									%endif
								%endfor
							</div>
						%endif
					</div>
				%endfor
			</div>
			<div class="clear"></div>
		</div>
		<div class="floatRight">
			<div class="spacerButtons">
				<span class="forward floatLeft" id="submitter"><span>${_("FF_POOLDETAILS_Invite Friends")}</span> <input type="button" value="&gt;"/></span>
			</div>
		</div>
		</form>
	</div>
<div class="clear"></div>
</div>

