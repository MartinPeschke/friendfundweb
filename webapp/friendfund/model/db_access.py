import logging, pyodbc, osfrom lxml import etreeclass SProcException(Exception):	passclass SProcWarningMessage(Exception):	passdef _execute(dbcursor, log, query, *args):	if filter(None, args):		if len(''.join(args)) < 1000:			log.info( 'QUERY: %s with %s' , query, args and unicode(args))		else:			log.info( 'QUERY: %s with %s' , query, args and '\n'.join([unicode(a[:5000]) for a in args]))	else:		log.info( 'QUERY: %s' , query )	log.debug('CONNECTION IN HAND')	if filter(None, args):		dbcursor.execute(query, *args)	else:		dbcursor.execute(query)		log.debug('EXECUTED QUERY')	r = dbcursor.fetchone()[0]	if not isinstance(r, basestring):		return None, dbcursor	else:		log.info( 'RESULT %s', r )		result = etree.fromstring(r)		result_state = int(result.get('status', 1))				#verify sproc exited without error		if result.tag != 'RESULT' or result_state != 0:			log.error("SProc Error Occured: %s:%s (%s)" % 						(result.get('proc_name'), result.get('status', 0), result.get('error_message')))			raise SProcException("SProc Error Occured: %s:%s (%s)" % 						(result.get('proc_name'), result.get('status', 0), result.get('error_message')))		#check for db messages or warnings		elif result_state == 0 and result.get('db_message', None):			log.warning("SProc Warning Occured: %s: (%s)" % 						(query, result.get('db_message')))			raise SProcWarningMessage(result.get('db_message', None))		return result, dbcursordef execute_query(DBPool, log, *args, **kwargs):	try:		conn = DBPool.connection()		log.debug('ACQUIRING CONNECTION')		cur = conn.cursor()		return _execute(cur, log, *args, **kwargs)	except pyodbc.Error, e:		log.error('PANIC CONNECTION LOST REMOVING IT....')		raise e	else:		log.debug('CONNECTION CLOSING....')		cur.close()		conn.close()		log.debug('CONNECTION CLOSED & RETURNED')